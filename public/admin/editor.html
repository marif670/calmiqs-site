<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Calmiqs Editor</title>
    <style>
      body {
        font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial;
        background: #f8fafc;
        color: #0f1724;
        padding: 16px;
      }
      .toolbar {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-bottom: 8px;
      }
      .btn {
        padding: 6px 10px;
        border-radius: 6px;
        border: 1px solid #dbe3eb;
        background: #fff;
        cursor: pointer;
      }
      .btn.primary {
        background: #3b82f6;
        color: #fff;
        border-color: #3b82f6;
      }
      .editor {
        background: #fff;
        border: 1px solid #e6edf3;
        border-radius: 8px;
        padding: 12px;
        min-height: 340px;
      }
      .editor:focus {
        outline: 2px solid #cfe7ff;
      }
      .small {
        font-size: 13px;
        color: #64748b;
      }
      .inline-img {
        max-width: 100%;
        height: auto;
        border-radius: 4px;
        margin: 12px auto;
        display: block;
      }
      .inline-img.left {
        float: left;
        margin: 0 12px 12px 0;
      }
      .inline-img.right {
        float: right;
        margin: 0 0 12px 12px;
      }
      .inline-img.center {
        display: block;
        margin: 12px auto;
      }
      .img-selected {
        outline: 3px solid rgba(59, 130, 246, 0.35);
      }
      .inline-toolbar {
        position: absolute;
        background: #fff;
        border: 1px solid #e6edf3;
        padding: 8px;
        border-radius: 6px;
        z-index: 1500;
        box-shadow: 0 4px 14px rgba(2, 6, 23, 0.08);
      }
      .input {
        padding: 6px;
        border-radius: 4px;
        border: 1px solid #e6edf3;
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 12px;
      }
      .thumb {
        width: 100%;
        height: 120px;
        object-fit: cover;
        border: 1px solid #dbe3eb;
        border-radius: 4px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <script>
      window.CALMIQS_ADMIN_TOKEN = "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Hadia@2017_Ayesha@2007";
      const WORKER_BASE = "https://calmiqs-images-worker.techaipet.workers.dev";
      const POST_BASE = WORKER_BASE + "/posts";
      const IMAGE_BASE = WORKER_BASE + "/files/";
      const UPLOAD_URL = WORKER_BASE + "/upload";
      const LIST_URL = WORKER_BASE + "/list";
      const UPDATE_URL = WORKER_BASE + "/update";
    </script>

    <h1>Calmiqs â€” Editor</h1>

    <!-- Blog control toolbar -->
    <div class="toolbar">
      <input id="postTitle" class="input" placeholder="Post Title" style="width: 220px" />
      <button id="newBtn" class="btn">New</button>
      <button id="loadBtn" class="btn">Load</button>
      <button id="saveBtn" class="btn primary">Save</button>
      <button id="deleteBtn" class="btn">Delete</button>
    </div>

    <!-- Formatting toolbar -->
    <div class="toolbar">
      <button class="btn" data-cmd="bold"><b>B</b></button>
      <button class="btn" data-cmd="italic"><i>I</i></button>
      <button class="btn" data-cmd="h1">H1</button>
      <button class="btn" data-cmd="h2">H2</button>
      <button class="btn" data-cmd="h3">H3</button>
      <button class="btn" data-cmd="p">P</button>
      <button class="btn" data-cmd="link">Link</button>
      <div style="flex: 1"></div>
      <button id="toggleHtmlBtn" class="btn">Show HTML</button>
    </div>

    <div id="editor" class="editor" contenteditable="true">
      <p>Start writing your post...</p>
    </div>

    <!-- Inline image controls -->
    <div style="margin-top: 10px; display: flex; gap: 8px; align-items: center">
      <input id="inlineImageFile" type="file" accept="image/*" />
      <button id="insertInlineBtn" class="btn">Upload & Insert</button>
      <button id="selectImageBtn" class="btn">Select from Library</button>
    </div>

    <!-- Inline image toolbar -->
    <div id="inlineToolbar" class="inline-toolbar" style="display: none">
      <div style="display: flex; gap: 6px; align-items: center; flex-wrap: wrap">
        <input id="imgAlt" class="input" placeholder="Alt text" style="width: 180px" />
        <input id="imgWidth" class="input" placeholder="Width (px or %)" style="width: 120px" />
        <button id="alignLeft" class="btn">Left Wrap</button>
        <button id="alignRight" class="btn">Right Wrap</button>
        <button id="alignCenter" class="btn">No Wrap</button>
        <button id="saveImageMeta" class="btn primary">Save</button>
      </div>
    </div>

    <!-- Library modal -->
    <div
      id="libraryModal"
      style="
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.6);
        z-index: 999;
        align-items: center;
        justify-content: center;
      "
    >
      <div
        style="
          background: #fff;
          border-radius: 6px;
          padding: 16px;
          max-width: 900px;
          width: 90%;
          max-height: 80vh;
          overflow: auto;
        "
      >
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
          "
        >
          <strong>Image Library</strong>
          <button id="closeLibrary" class="btn">Close</button>
        </div>
        <div id="libraryGrid" class="grid"></div>
      </div>
    </div>

    <script>
      (async function () {
        const ed = document.getElementById("editor");
        const toolbarBtns = document.querySelectorAll(".toolbar [data-cmd]");
        const toggleHtmlBtn = document.getElementById("toggleHtmlBtn");
        const inlineToolbar = document.getElementById("inlineToolbar");
        const imgAltInput = document.getElementById("imgAlt");
        const imgWidthInput = document.getElementById("imgWidth");
        const saveImageMetaBtn = document.getElementById("saveImageMeta");
        let currentImg = null;

        // Authenticated fetch helper
        async function authFetch(url, opts = {}) {
          opts.headers = opts.headers || {};
          opts.headers["X-Admin-Token"] = window.CALMIQS_ADMIN_TOKEN;
          return fetch(url, opts);
        }

        // Toolbar commands
        toolbarBtns.forEach((b) => {
          b.addEventListener("click", () => {
            const c = b.dataset.cmd;
            if (c === "link") {
              const u = prompt("URL");
              if (u) document.execCommand("createLink", false, u);
            } else if (["h1", "h2", "h3", "p"].includes(c)) {
              document.execCommand("formatBlock", false, c);
            } else {
              document.execCommand(c, false, null);
            }
          });
        });

        // Toggle HTML view
        toggleHtmlBtn.addEventListener("click", () => {
          if (ed.contentEditable === "true") {
            ed.textContent = ed.innerHTML;
            ed.contentEditable = "false";
            toggleHtmlBtn.textContent = "Hide HTML";
          } else {
            ed.innerHTML = ed.textContent;
            ed.contentEditable = "true";
            toggleHtmlBtn.textContent = "Show HTML";
          }
        });

        // Upload + insert image
        document.getElementById("insertInlineBtn").addEventListener("click", async () => {
          const file = document.getElementById("inlineImageFile").files[0];
          if (!file) return alert("Choose file");
          const fd = new FormData();
          fd.append("file", file);
          const r = await authFetch(UPLOAD_URL, { method: "POST", body: fd });
          const j = await r.json();
          if (!r.ok) return alert(j.error || "Upload failed");
          insertImage(j.url || IMAGE_BASE + encodeURIComponent(j.metadata.r2Key), j.metadata.alt);
        });

        // Library modal
        const lib = document.getElementById("libraryModal");
        document.getElementById("selectImageBtn").onclick = () => {
          lib.style.display = "flex";
          loadLibrary();
        };
        document.getElementById("closeLibrary").onclick = () => (lib.style.display = "none");
        async function loadLibrary() {
          const r = await authFetch(LIST_URL);
          const j = await r.json();
          const g = document.getElementById("libraryGrid");
          g.innerHTML = "";
          (j.images || []).forEach((m) => {
            const img = document.createElement("img");
            img.src = IMAGE_BASE + encodeURIComponent(m.r2Key);
            img.className = "thumb";
            img.title = m.title || m.filename;
            img.onclick = () => {
              insertImage(img.src, m.alt);
              lib.style.display = "none";
            };
            g.appendChild(img);
          });
        }

        // Insert image
        function insertImage(src, alt) {
          const img = document.createElement("img");
          img.src = src;
          img.alt = alt || "";
          img.className = "inline-img center";
          ed.appendChild(img);
          attachImg(img);
        }

        // Image toolbar + wrap
        function attachImg(img) {
          img.addEventListener("click", (ev) => {
            ev.stopPropagation();
            document
              .querySelectorAll(".inline-img")
              .forEach((i) => i.classList.remove("img-selected"));
            img.classList.add("img-selected");
            currentImg = img;
            const r = img.getBoundingClientRect();
            inlineToolbar.style.left = r.left + window.scrollX + "px";
            inlineToolbar.style.top = r.bottom + window.scrollY + 6 + "px";
            inlineToolbar.style.display = "block";
            imgAltInput.value = img.alt;
            imgWidthInput.value = img.style.width || "";
          });
        }

        ed.querySelectorAll("img.inline-img").forEach(attachImg);
        document.addEventListener("click", (e) => {
          if (!inlineToolbar.contains(e.target)) {
            inlineToolbar.style.display = "none";
            document
              .querySelectorAll(".inline-img")
              .forEach((i) => i.classList.remove("img-selected"));
          }
        });

        saveImageMetaBtn.onclick = () => {
          if (!currentImg) return;
          currentImg.alt = imgAltInput.value;
          const w = imgWidthInput.value.trim();
          if (w) currentImg.style.width = w.endsWith("%") || w.endsWith("px") ? w : w + "px";
          inlineToolbar.style.display = "none";
        };
        document.getElementById("alignLeft").onclick = () => {
          if (currentImg) {
            currentImg.className = "inline-img left";
            inlineToolbar.style.display = "none";
          }
        };
        document.getElementById("alignRight").onclick = () => {
          if (currentImg) {
            currentImg.className = "inline-img right";
            inlineToolbar.style.display = "none";
          }
        };
        document.getElementById("alignCenter").onclick = () => {
          if (currentImg) {
            currentImg.className = "inline-img center";
            inlineToolbar.style.display = "none";
          }
        };

        // === Post operations ===
        const titleEl = document.getElementById("postTitle");
        const newBtn = document.getElementById("newBtn");
        const loadBtn = document.getElementById("loadBtn");
        const saveBtn = document.getElementById("saveBtn");
        const deleteBtn = document.getElementById("deleteBtn");

        newBtn.onclick = () => {
          titleEl.value = "";
          ed.innerHTML = "<p></p>";
        };
        loadBtn.onclick = async () => {
          const slug = prompt("Enter post slug");
          if (!slug) return;
          const r = await authFetch(POST_BASE + "/" + slug);
          const j = await r.json();
          if (!r.ok) return alert("Not found");
          titleEl.value = j.title;
          ed.innerHTML = j.content || "";
        };
        saveBtn.onclick = async () => {
          if (!titleEl.value.trim()) return alert("Enter title first");
          const slug = titleEl.value
            .toLowerCase()
            .replace(/[^a-z0-9]+/g, "-")
            .replace(/^-+|-+$/g, "");
          const body = { title: titleEl.value.trim(), slug, content: ed.innerHTML };
          const r = await authFetch(POST_BASE, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body),
          });
          if (r.ok) alert("Saved!");
          else alert("Save failed");
        };
        deleteBtn.onclick = async () => {
          const slug = prompt("Enter slug to delete");
          if (!slug) return;
          const r = await authFetch(POST_BASE + "/" + slug, { method: "DELETE" });
          alert(r.ok ? "Deleted" : "Failed");
        };
      })();
    </script>
  </body>
</html>
