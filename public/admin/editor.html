<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Calmiqs Blog Editor</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#4FA49A",
              accent: "#FFD580",
              tech: "#5A67D8",
            },
            fontFamily: {
              sans: ["Poppins", "sans-serif"],
            },
          },
        },
      };
    </script>
    <link rel="stylesheet" href="/assets/css/style.css?v=12" />
    <style>
      /* Inline image styling for contenteditable editor */
      #editor img {
        max-width: 800px;
        margin: 1rem 0;
        border-radius: 0.5rem;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      }
      #editor img.float-left {
        float: left;
        margin-right: 0.5rem;
      }
      #editor img.float-right {
        float: right;
        margin-left: 0.5rem;
      }
      #editor img.mx-auto {
        display: block;
        margin-left: auto;
        margin-right: auto;
      }
      #editor:empty:before {
        content: attr(placeholder);
        color: gray;
      }
    </style>
  </head>
  <body class="bg-[#F9FAFB] text-gray-800 font-sans min-h-screen">
    <!-- üîí Login Section -->
    <section id="authSection" class="flex items-center justify-center min-h-screen">
      <div class="bg-white p-8 rounded-2xl shadow-lg w-full max-w-md text-center">
        <h1 class="text-3xl font-bold text-primary mb-4">üîí Calmiqs Admin Login</h1>
        <input
          id="passwordInput"
          type="password"
          placeholder="Enter password"
          class="w-full border rounded-lg px-4 py-2 mb-4 focus:outline-none focus:ring-2 focus:ring-primary"
        />
        <button
          id="loginBtn"
          class="bg-primary hover:bg-tech text-white font-medium px-6 py-2 rounded-lg transition w-full"
        >
          Login
        </button>
      </div>
    </section>

    <!-- üìù Editor Section -->
    <section id="editorSection" class="hidden max-w-5xl mx-auto p-6">
      <h1 class="text-4xl font-bold text-primary mb-6 text-center">ü™∂ Calmiqs Blog Editor</h1>

      <!-- File Controls -->
      <div class="flex justify-between items-center mb-4">
        <button
          id="loadBtn"
          class="bg-accent text-gray-800 px-4 py-2 rounded-lg shadow hover:bg-yellow-400 transition"
        >
          Load Posts
        </button>
        <div class="flex gap-2">
          <button
            id="saveBtn"
            class="bg-primary text-white px-4 py-2 rounded-lg shadow hover:bg-tech transition"
          >
            Save Post
          </button>
          <button
            id="deleteBtn"
            class="bg-red-500 text-white px-4 py-2 rounded-lg shadow hover:bg-red-700 transition"
          >
            Delete Post
          </button>
        </div>
      </div>

      <!-- Posts Dropdown -->
      <div class="mb-4">
        <label for="postSelect" class="block text-sm font-medium mb-1">Select Post:</label>
        <select
          id="postSelect"
          class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary"
        ></select>
      </div>

      <!-- Editor Form -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Hero Image & Info -->
        <div>
          <label class="block text-sm font-medium mb-1">Post Key (slug)</label>
          <input
            id="key"
            type="text"
            placeholder="e.g., mindful-breathing"
            class="w-full border rounded-lg px-4 py-2 mb-3 focus:outline-none focus:ring-2 focus:ring-primary"
          />

          <label class="block text-sm font-medium mb-1">Title</label>
          <input
            id="title"
            type="text"
            placeholder="Article title"
            class="w-full border rounded-lg px-4 py-2 mb-3 focus:outline-none focus:ring-2 focus:ring-primary"
          />

          <label class="block text-sm font-medium mb-1">Date</label>
          <input
            id="date"
            type="text"
            placeholder="e.g., November 2, 2025"
            class="w-full border rounded-lg px-4 py-2 mb-3 focus:outline-none focus:ring-2 focus:ring-primary"
          />

          <label class="block text-sm font-medium mb-1">Hero Image</label>
          <input
            id="image"
            type="text"
            placeholder="URL after upload"
            class="w-full border rounded-lg px-4 py-2 mb-3 focus:outline-none focus:ring-2 focus:ring-primary"
          />

          <label class="block text-sm font-medium mb-1">Hero Image Alt Text</label>
          <input
            id="imageAlt"
            type="text"
            placeholder="Describe the image for accessibility"
            class="w-full border rounded-lg px-4 py-2 mb-3 focus:outline-none focus:ring-2 focus:ring-primary"
          />

          <input type="file" id="heroImageFile" class="mb-3" />
          <button
            id="uploadHeroBtn"
            class="bg-accent text-gray-800 px-4 py-2 rounded-lg shadow hover:bg-yellow-400 transition mb-6"
          >
            Upload Hero Image
          </button>

          <label class="block text-sm font-medium mb-1">Excerpt</label>
          <textarea
            id="excerpt"
            rows="3"
            placeholder="Short preview text..."
            class="w-full border rounded-lg px-4 py-2 mb-3 focus:outline-none focus:ring-2 focus:ring-primary"
          ></textarea>
        </div>

        <!-- Content & Inline Images -->
        <div>
          <label class="block text-sm font-medium mb-1">Content</label>

          <!-- Contenteditable editor -->
          <div
            id="editor"
            contenteditable="true"
            class="w-full h-96 border rounded-lg p-4 mb-3 bg-white overflow-auto"
            placeholder="<p>Your article here...</p>"
          ></div>

          <!-- Toolbar -->
          <div class="flex flex-wrap gap-2 mb-3">
            <button data-action="bold" class="px-2 py-1 bg-gray-200 rounded">Bold</button>
            <button data-action="italic" class="px-2 py-1 bg-gray-200 rounded">Italic</button>
            <button data-action="h2" class="px-2 py-1 bg-gray-200 rounded">H2</button>
            <button data-action="h3" class="px-2 py-1 bg-gray-200 rounded">H3</button>
            <button data-action="ul" class="px-2 py-1 bg-gray-200 rounded">UL</button>
            <button data-action="ol" class="px-2 py-1 bg-gray-200 rounded">OL</button>
            <button data-action="link" class="px-2 py-1 bg-gray-200 rounded">Link</button>
            <button id="insertImageBtn" class="px-2 py-1 bg-accent rounded">‚ûï Inline Image</button>
          </div>

          <!-- Inline Image File Upload -->
          <input type="file" id="inlineImageFile" class="mb-2" />
        </div>
      </div>

      <!-- Toggle Preview -->
      <button
        onclick="document.getElementById('previewContainer').classList.toggle('hidden')"
        class="mt-6 bg-primary text-white px-4 py-2 rounded-lg hover:bg-tech transition"
      >
        Toggle Preview
      </button>

      <!-- Live Preview -->
      <h2 class="text-2xl font-semibold mt-8 mb-4">ü™∂ Live Preview</h2>
      <div id="previewContainer" class="bg-white shadow-lg rounded-xl p-6 border border-gray-100">
        <div id="previewContent" class="prose max-w-none"></div>
      </div>
    </section>

    <script>
      // === CONFIG ===
      const PASSWORD = "calmiqs2025";
      const KV_URL = "/posts";
      const IMAGE_UPLOAD_URL = "/images/upload";

      let posts = {};

      const authSection = document.getElementById("authSection");
      const editorSection = document.getElementById("editorSection");
      const passwordInput = document.getElementById("passwordInput");
      const loginBtn = document.getElementById("loginBtn");
      const postSelect = document.getElementById("postSelect");
      const saveBtn = document.getElementById("saveBtn");
      const deleteBtn = document.getElementById("deleteBtn");

      // === LOGIN ===
      loginBtn.addEventListener("click", () => {
        if (passwordInput.value.trim() === PASSWORD) {
          sessionStorage.setItem("calmiqsAuth", "true");
          authSection.classList.add("hidden");
          editorSection.classList.remove("hidden");
          loadPosts();
        } else alert("Incorrect password.");
      });

      if (sessionStorage.getItem("calmiqsAuth") === "true") {
        authSection.classList.add("hidden");
        editorSection.classList.remove("hidden");
        loadPosts();
      }

      // === KV POSTS ===
      async function loadPosts() {
        try {
          const res = await fetch(KV_URL);
          if (!res.ok) throw new Error("Could not load posts from KV");
          posts = await res.json();
          populateSelect();
        } catch (err) {
          console.error(err);
          alert("‚ùå Could not load posts from KV.");
        }
      }

      function populateSelect() {
        postSelect.innerHTML =
          '<option value="">‚ûï New Post</option>' +
          Object.keys(posts)
            .map((key) => `<option value="${key}">${key}</option>`)
            .join("");
      }

      postSelect.addEventListener("change", () => {
        const key = postSelect.value;
        if (!key) return clearForm();
        const post = posts[key];
        document.getElementById("key").value = key;
        ["title", "date", "image", "imageAlt", "excerpt"].forEach((id) => {
          document.getElementById(id).value = post[id] || "";
        });
        document.getElementById("editor").innerHTML = post.content || "";
        updatePreview();
      });

      function clearForm() {
        document.getElementById("key").value = "";
        ["title", "date", "image", "imageAlt", "excerpt"].forEach((id) => {
          document.getElementById(id).value = "";
        });
        document.getElementById("editor").innerHTML = "";
        updatePreview();
      }

      // === SAVE POST ===
      async function savePost() {
        const key = document.getElementById("key").value.trim();
        if (!key) return alert("Provide a key (slug)");
        const data = ["title", "date", "image", "excerpt"].reduce((obj, id) => {
          obj[id] = document.getElementById(id).value.trim();
          return obj;
        }, {});
        data.imageAlt = document.getElementById("imageAlt").value.trim();
        data.content = document.getElementById("editor").innerHTML;
        try {
          const res = await fetch(KV_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ key, data }),
          });
          const result = await res.json();
          if (result.success) {
            alert("‚úÖ Post saved!");
            loadPosts();
          } else alert("‚ö†Ô∏è " + (result.error || "Unknown error"));
        } catch (err) {
          console.error(err);
          alert("‚ùå Failed to save post.");
        }
      }

      // === DELETE POST ===
      async function deletePost() {
        const key = postSelect.value;
        if (!key) return alert("Select a post");
        if (!confirm(`Delete '${key}'?`)) return;
        try {
          const res = await fetch(`${KV_URL}?key=${encodeURIComponent(key)}`, { method: "DELETE" });
          const result = await res.json();
          if (result.success) {
            alert("üóëÔ∏è Post deleted");
            clearForm();
            loadPosts();
          } else alert("‚ö†Ô∏è " + (result.error || "Unknown error"));
        } catch (err) {
          console.error(err);
          alert("‚ùå Failed to delete post.");
        }
      }

      // === HERO IMAGE UPLOAD ===
      document.getElementById("uploadHeroBtn").addEventListener("click", async () => {
        const fileInput = document.getElementById("heroImageFile");
        const altInput = document.getElementById("imageAlt");
        if (!fileInput.files[0]) return alert("Select a file");

        const formData = new FormData();
        formData.append("file", fileInput.files[0]);
        formData.append("alt", altInput.value || "");

        try {
          const res = await fetch(IMAGE_UPLOAD_URL, { method: "POST", body: formData });
          const result = await res.json();
          if (result.success) {
            document.getElementById("image").value = result.url;
            document.getElementById("imageAlt").value = result.meta.alt || "";
            alert("‚úÖ Hero image uploaded");
            updatePreview();
          } else alert("‚ùå Failed to upload image: " + (result.error || "Unknown error"));
        } catch (err) {
          console.error(err);
          alert("‚ùå Failed to upload image.");
        }
      });

      // === INLINE IMAGE UPLOAD ===
      document.getElementById("insertImageBtn").addEventListener("click", async () => {
        const fileInput = document.getElementById("inlineImageFile");
        if (!fileInput.files[0]) return alert("Select a file");

        const altText =
          prompt("Enter alt text for this image:", fileInput.files[0].name) ||
          fileInput.files[0].name;
        const alignment = prompt("Enter alignment (left, right, center):", "center") || "center";

        const formData = new FormData();
        formData.append("file", fileInput.files[0]);
        formData.append("alt", altText);
        formData.append("alignment", alignment);

        try {
          const res = await fetch(IMAGE_UPLOAD_URL, { method: "POST", body: formData });
          const result = await res.json();
          if (result.success) {
            const editor = document.getElementById("editor");
            const imgHTML = `<img src="${result.url}" alt="${result.meta.alt}" class="my-4 rounded-lg shadow-md ${result.meta.alignment}" />`;
            insertAtCursor(editor, imgHTML);
            updatePreview();
            alert("‚úÖ Inline image inserted");
          } else alert("‚ùå Failed to insert inline image: " + (result.error || "Unknown error"));
        } catch (err) {
          console.error(err);
          alert("‚ùå Failed to insert inline image.");
        }
      });

      function insertAtCursor(editor, html) {
        editor.focus();
        const sel = window.getSelection();
        if (!sel.rangeCount) return;
        const range = sel.getRangeAt(0);
        range.deleteContents();
        const frag = document.createRange().createContextualFragment(html);
        range.insertNode(frag);
        range.collapse(false);
      }

      // === LIVE PREVIEW ===
      const titleInput = document.getElementById("title");
      const dateInput = document.getElementById("date");
      const imageInput = document.getElementById("image");
      const imageAltInput = document.getElementById("imageAlt");
      const editorDiv = document.getElementById("editor");
      const preview = document.getElementById("previewContent");

      function updatePreview() {
        const title = titleInput.value || "Untitled Post";
        const date = dateInput.value || "No date set";
        const image = imageInput.value || "https://via.placeholder.com/800x400?text=Preview";
        const imageAlt = imageAltInput.value || "Preview image";
        const content = editorDiv.innerHTML || "<p>Start typing...</p>";
        preview.innerHTML = `
          <img src="${image}" alt="${imageAlt}" class="rounded-xl mb-4 shadow-md w-full max-h-96 object-cover" />
          <h3 class="text-3xl font-bold mb-2 text-primary">${title}</h3>
          <p class="text-gray-500 mb-6">${date}</p>
          <div class="text-gray-800 leading-relaxed">${content}</div>
        `;
      }

      [titleInput, dateInput, imageInput, imageAltInput, editorDiv].forEach((el) =>
        el.addEventListener("input", updatePreview)
      );
      updatePreview();

      // === BUTTON EVENTS ===
      document.getElementById("loadBtn").addEventListener("click", loadPosts);
      saveBtn.addEventListener("click", savePost);
      deleteBtn.addEventListener("click", deletePost);

      // === TOOLBAR FORMATTING ===
      document.querySelectorAll("[data-action]").forEach((btn) => {
        btn.addEventListener("click", () => {
          const action = btn.getAttribute("data-action");
          if (action === "link") {
            const url = prompt("Enter URL:", "https://");
            if (url) document.execCommand("createLink", false, url);
          } else {
            document.execCommand(action, false, null);
          }
          updatePreview();
        });
      });
    </script>
  </body>
</html>
