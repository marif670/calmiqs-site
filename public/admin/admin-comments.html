<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Comments Moderation ‚Äì Calmiqs Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#4FA49A",
              accent: "#FFD580",
              tech: "#5A67D8",
            },
          },
        },
      };
    </script>
    <style>
      .status-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-weight: 500;
      }
      .pending {
        background: #fef3c7;
        color: #92400e;
      }
      .approved {
        background: #d1fae5;
        color: #065f46;
      }
      .rejected {
        background: #fee2e2;
        color: #991b1b;
      }
    </style>
  </head>
  <body class="bg-gray-50 font-sans">
    <script>
      window.CALMIQS_ADMIN_TOKEN = "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Hadia@2017_Ayesha@2007";
    </script>

    <div class="max-w-7xl mx-auto px-4 py-8">
      <!-- Header -->
      <div class="mb-8 flex items-center justify-between">
        <div>
          <h1 class="text-3xl font-bold text-gray-800">üí¨ Comments Moderation</h1>
          <p class="text-gray-600 mt-1">Review and manage user comments</p>
        </div>
        <a href="editor.html" class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded-lg transition">
          ‚Üê Back to Editor
        </a>
      </div>

      <!-- Stats Cards -->
      <div class="grid md:grid-cols-3 gap-6 mb-8">
        <div class="bg-white rounded-lg shadow p-6">
          <div class="text-sm text-gray-600 mb-1">Pending Review</div>
          <div class="text-3xl font-bold text-yellow-600" id="pendingCount">-</div>
        </div>
        <div class="bg-white rounded-lg shadow p-6">
          <div class="text-sm text-gray-600 mb-1">Approved</div>
          <div class="text-3xl font-bold text-green-600" id="approvedCount">-</div>
        </div>
        <div class="bg-white rounded-lg shadow p-6">
          <div class="text-sm text-gray-600 mb-1">Total Comments</div>
          <div class="text-3xl font-bold text-gray-800" id="totalCount">-</div>
        </div>
      </div>

      <!-- Filters -->
      <div class="bg-white rounded-lg shadow p-4 mb-6">
        <div class="flex flex-wrap gap-4 items-center">
          <div>
            <label class="text-sm font-medium text-gray-700 mr-2">Filter by Status:</label>
            <select id="statusFilter" class="px-3 py-2 border rounded-lg">
              <option value="all">All</option>
              <option value="pending" selected>Pending</option>
              <option value="approved">Approved</option>
              <option value="rejected">Rejected</option>
            </select>
          </div>
          <div class="flex-1">
            <input
              type="text"
              id="searchComments"
              placeholder="Search by name, email, or content..."
              class="w-full px-4 py-2 border rounded-lg"
            />
          </div>
          <button
            id="refreshBtn"
            class="bg-primary hover:bg-accent text-white px-4 py-2 rounded-lg transition"
          >
            üîÑ Refresh
          </button>
        </div>
      </div>

      <!-- Comments List -->
      <div id="commentsList" class="space-y-4">
        <div class="text-center py-12 text-gray-500">
          <div class="text-5xl mb-3">‚è≥</div>
          <p>Loading comments...</p>
        </div>
      </div>
    </div>

    <script>
      const ADMIN_TOKEN = window.CALMIQS_ADMIN_TOKEN;
      const API_BASE = "/api"; // Use relative path

      let allComments = [];
      let filteredComments = [];

      // Auth fetch helper
      async function authFetch(url, opts = {}) {
        opts.headers = opts.headers || {};
        opts.headers["X-Admin-Token"] = ADMIN_TOKEN;
        return fetch(url, opts);
      }

      // Load all comments (from all posts)
      async function loadAllComments() {
        try {
          console.log("Loading all comments...");
          const res = await authFetch(`/api/admin/comments`);

          if (!res.ok) {
            const errorText = await res.text();
            console.error("Failed to load comments:", res.status, errorText);
            throw new Error(`HTTP ${res.status}: ${errorText}`);
          }

          const data = await res.json();
          console.log("Received data:", data);

          allComments = data.comments || [];

          // Get post titles for display
          try {
            const postsRes = await authFetch(`/api/posts`);
            const posts = await postsRes.json();

            // Add post titles to comments
            allComments.forEach((comment) => {
              const post = posts[comment.postSlug];
              comment.postTitle = post ? post.title : comment.postSlug;
            });
          } catch (e) {
            console.error("Failed to load post titles:", e);
          }

          updateStats();
          applyFilters();
        } catch (error) {
          console.error("Failed to load comments:", error);
          document.getElementById("commentsList").innerHTML = `
          <div class="bg-red-50 border border-red-200 rounded-lg p-8 text-center">
            <p class="text-red-600 font-medium">‚ùå Failed to load comments</p>
            <p class="text-sm text-red-500 mt-2">${error.message}</p>
            <button onclick="loadAllComments()" class="mt-4 bg-red-500 text-white px-4 py-2 rounded">
              Retry
            </button>
          </div>
        `;
        }
      }

      // Update stats
      function updateStats() {
        const pending = allComments.filter((c) => c.status === "pending").length;
        const approved = allComments.filter((c) => c.status === "approved").length;

        document.getElementById("pendingCount").textContent = pending;
        document.getElementById("approvedCount").textContent = approved;
        document.getElementById("totalCount").textContent = allComments.length;
      }

      // Apply filters
      function applyFilters() {
        const status = document.getElementById("statusFilter").value;
        const search = document.getElementById("searchComments").value.toLowerCase();

        filteredComments = allComments.filter((comment) => {
          const matchesStatus = status === "all" || comment.status === status;
          const matchesSearch =
            !search ||
            comment.name.toLowerCase().includes(search) ||
            comment.email.toLowerCase().includes(search) ||
            comment.comment.toLowerCase().includes(search) ||
            (comment.postTitle && comment.postTitle.toLowerCase().includes(search));

          return matchesStatus && matchesSearch;
        });

        renderComments();
      }

      // Render comments
      function renderComments() {
        const container = document.getElementById("commentsList");

        if (filteredComments.length === 0) {
          container.innerHTML = `
          <div class="bg-white rounded-lg shadow p-12 text-center">
            <div class="text-5xl mb-3">üì≠</div>
            <p class="text-gray-600 font-medium">No comments found</p>
            <p class="text-sm text-gray-500 mt-2">Try adjusting your filters</p>
          </div>
        `;
          return;
        }

        // Sort by date (newest first)
        const sorted = [...filteredComments].sort(
          (a, b) => new Date(b.createdAt) - new Date(a.createdAt)
        );

        container.innerHTML = sorted
          .map(
            (comment) => `
        <div class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition" data-comment-id="${
          comment.id
        }">
          <div class="flex items-start justify-between mb-4">
            <div class="flex-1">
              <div class="flex items-center gap-3 mb-2">
                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-primary to-accent flex items-center justify-center text-white font-bold">
                  ${getInitials(comment.name)}
                </div>
                <div>
                  <div class="font-semibold text-gray-800">${escapeHtml(comment.name)}</div>
                  <div class="text-xs text-gray-500">${escapeHtml(comment.email)}</div>
                </div>
              </div>
              
              <div class="text-sm text-gray-600 mb-1">
                On post: <a href="/post-template.html?post=${
                  comment.postSlug
                }" target="_blank" class="text-primary hover:underline">
                  ${escapeHtml(comment.postTitle || comment.postSlug)}
                </a>
              </div>
            </div>

            <span class="status-badge ${comment.status}">
              ${comment.status === "pending" ? "‚è≥" : comment.status === "approved" ? "‚úÖ" : "‚ùå"} 
              ${comment.status}
            </span>
          </div>

          <div class="bg-gray-50 rounded-lg p-4 mb-4">
            <p class="text-gray-700 leading-relaxed">${escapeHtml(comment.comment)}</p>
          </div>

          <div class="flex items-center justify-between text-sm text-gray-500">
            <div class="flex gap-4">
              <span>üìÖ ${formatDate(comment.createdAt)}</span>
              <span>üåê IP: ${comment.ip || "unknown"}</span>
              ${comment.parentId ? "<span>‚Ü©Ô∏è Reply</span>" : ""}
            </div>

            ${
              comment.status === "pending"
                ? `
              <div class="flex gap-2">
                <button 
                  onclick="moderateComment('${comment.postSlug}', '${comment.id}', 'approve')"
                  class="bg-green-500 hover:bg-green-600 text-white px-4 py-1.5 rounded transition text-sm font-medium"
                >
                  ‚úÖ Approve
                </button>
                <button 
                  onclick="moderateComment('${comment.postSlug}', '${comment.id}', 'reject')"
                  class="bg-red-500 hover:bg-red-600 text-white px-4 py-1.5 rounded transition text-sm font-medium"
                >
                  ‚ùå Reject
                </button>
              </div>
            `
                : `
              <button 
                onclick="deleteComment('${comment.postSlug}', '${comment.id}')"
                class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-1.5 rounded transition text-sm font-medium"
              >
                üóëÔ∏è Delete
              </button>
            `
            }
          </div>
        </div>
      `
          )
          .join("");
      }

      // Moderate comment
      async function moderateComment(postSlug, commentId, action) {
        try {
          console.log("Moderating:", { postSlug, commentId, action });

          const res = await authFetch(`/api/admin/moderate`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ postSlug, commentId, action }),
          });

          if (res.ok) {
            const result = await res.json();
            console.log("Moderation result:", result);
            await loadAllComments();
          } else {
            const error = await res.json();
            alert("Failed to moderate: " + (error.error || "Unknown error"));
          }
        } catch (error) {
          console.error("Moderation error:", error);
          alert("Error: " + error.message);
        }
      }

      // Delete comment
      async function deleteComment(postSlug, commentId) {
        if (!confirm("Are you sure you want to delete this comment?")) return;

        try {
          console.log("Deleting:", { postSlug, commentId });

          const res = await authFetch(`/api/admin/delete`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ postSlug, commentId }),
          });

          if (res.ok) {
            const result = await res.json();
            console.log("Delete result:", result);
            await loadAllComments();
          } else {
            const error = await res.json();
            alert("Failed to delete: " + (error.error || "Unknown error"));
          }
        } catch (error) {
          console.error("Delete error:", error);
          alert("Error: " + error.message);
        }
      }

      // Helpers
      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      function getInitials(name) {
        return name
          .split(" ")
          .map((w) => w[0])
          .join("")
          .toUpperCase()
          .slice(0, 2);
      }

      function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString("en-US", {
          month: "short",
          day: "numeric",
          year: "numeric",
          hour: "2-digit",
          minute: "2-digit",
        });
      }

      // Event listeners
      document.getElementById("statusFilter").addEventListener("change", applyFilters);
      document.getElementById("searchComments").addEventListener("input", applyFilters);
      document.getElementById("refreshBtn").addEventListener("click", loadAllComments);

      // Make functions global for onclick handlers
      window.moderateComment = moderateComment;
      window.deleteComment = deleteComment;

      // Initialize
      loadAllComments();
    </script>
  </body>
</html>
