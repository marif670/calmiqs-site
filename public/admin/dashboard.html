<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Calmiqs Editor - Content Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#4FA49A",
              accent: "#FFD580",
              tech: "#5A67D8",
            },
            fontFamily: { sans: ["Poppins", "sans-serif"] },
          },
        },
      };
    </script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }
      .editor-toolbar button {
        padding: 0.5rem;
        border: 1px solid #d1d5db;
        background: white;
        border-radius: 0.375rem;
        cursor: pointer;
        transition: all 0.2s;
      }
      .editor-toolbar button:hover {
        background: #f3f4f6;
        border-color: #4fa49a;
      }
      #content {
        min-height: 400px;
        padding: 1rem;
        border: 2px solid #d1d5db;
        border-radius: 0.5rem;
        outline: none;
      }
      #content:focus {
        border-color: #4fa49a;
        box-shadow: 0 0 0 3px rgba(79, 164, 154, 0.1);
      }
      .modal-hidden {
        display: none !important;
      }
    </style>
  </head>

  <body class="bg-gray-50 font-sans">
    <script>
      window.CALMIQS_ADMIN_TOKEN = "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Hadia@2017_Ayesha@2007";
    </script>

    <!-- Header -->
    <header class="bg-white border-b sticky top-0 z-50 shadow-sm">
      <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
        <div class="flex items-center gap-4">
          <a href="/" class="flex items-center gap-2">
            <img src="/assets/logo.svg" alt="Calmiqs Logo" class="h-8 w-8" />
            <span class="text-2xl font-bold text-primary">Calmiqs Editor</span>
          </a>
        </div>
        <div class="flex items-center gap-3">
          <a
            href="/admin-comments.html"
            class="px-4 py-2 text-gray-700 hover:text-primary transition"
          >
            üí¨ Comments
          </a>
          <button
            id="logoutBtn"
            class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg transition"
          >
            Logout
          </button>
        </div>
      </div>
    </header>

    <!-- Tabs Navigation -->
    <nav class="bg-white border-b sticky top-16 z-40 shadow-sm">
      <div class="max-w-7xl mx-auto px-6 flex gap-4 overflow-x-auto">
        <button
          class="tab-btn py-4 px-4 border-b-2 border-primary text-primary font-medium"
          data-tab="editor"
        >
          üìù Editor
        </button>
        <button
          class="tab-btn py-4 px-4 border-b-2 border-transparent text-gray-600 hover:text-gray-900"
          data-tab="seo"
        >
          üîç SEO & Meta
        </button>
        <button
          class="tab-btn py-4 px-4 border-b-2 border-transparent text-gray-600 hover:text-gray-900"
          data-tab="images"
        >
          üñºÔ∏è Images
        </button>
        <button
          class="tab-btn py-4 px-4 border-b-2 border-transparent text-gray-600 hover:text-gray-900"
          data-tab="settings"
        >
          ‚öôÔ∏è Settings
        </button>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-6 py-8">
      <!-- EDITOR TAB -->
      <div id="editor" class="tab-content active">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
          <!-- Left: Editor -->
          <div class="lg:col-span-2 space-y-6">
            <!-- Post Management -->
            <div class="bg-white rounded-xl shadow p-6">
              <h2 class="text-xl font-bold text-primary mb-4">üìã Post Management</h2>
              <div class="grid grid-cols-2 gap-3 mb-6">
                <button
                  id="newPostBtn"
                  class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-accent transition"
                >
                  <i class="fas fa-plus"></i>
                  New Post
                </button>
                <button
                  id="loadPostBtn"
                  class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition"
                >
                  <i class="fas fa-folder-open"></i>
                  Load Post
                </button>
                <button
                  id="savePostBtn"
                  class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition"
                >
                  <i class="fas fa-save"></i>
                  Save Post
                </button>
                <button
                  id="deletePostBtn"
                  class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition"
                >
                  <i class="fas fa-trash"></i>
                  Delete Post
                </button>
              </div>
              <div class="space-y-3">
                <div>
                  <label class="block text-sm font-medium mb-2">Post Slug</label>
                  <input
                    type="text"
                    id="postSlug"
                    readonly
                    class="w-full px-4 py-2 border rounded-lg bg-gray-50"
                  />
                </div>
              </div>
            </div>

            <!-- Title -->
            <div class="bg-white rounded-xl shadow p-6">
              <label class="block text-sm font-medium mb-2">Post Title *</label>
              <input
                type="text"
                id="postTitle"
                class="w-full px-4 py-2 border rounded-lg text-2xl font-bold focus:outline-none focus:ring-2 focus:ring-primary"
                placeholder="Enter your post title..."
              />
            </div>

            <!-- Hero Image -->
            <div class="bg-white rounded-xl shadow p-6">
              <h2 class="text-lg font-bold text-primary mb-4">üñºÔ∏è Hero Image</h2>
              <div class="space-y-3">
                <div>
                  <label class="block text-sm font-medium mb-2">Upload Hero Image</label>
                  <input
                    type="file"
                    id="heroImageFile"
                    class="w-full px-4 py-2 border rounded-lg"
                    accept="image/*"
                  />
                </div>
                <div>
                  <label class="block text-sm font-medium mb-2">Image Alt Text</label>
                  <input
                    type="text"
                    id="heroAlt"
                    class="w-full px-4 py-2 border rounded-lg"
                    placeholder="Describe the image for accessibility"
                  />
                </div>
                <div class="grid grid-cols-2 gap-3">
                  <button
                    id="uploadHeroBtn"
                    class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-accent transition"
                  >
                    <i class="fas fa-cloud-upload-alt"></i>
                    Upload
                  </button>
                  <button
                    id="selectHeroBtn"
                    class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition"
                  >
                    <i class="fas fa-image"></i>
                    From Library
                  </button>
                </div>
                <div id="heroPreview" class="mt-4"></div>
              </div>
            </div>

            <!-- Content Editor -->
            <div class="bg-white rounded-xl shadow p-6">
              <h2 class="text-lg font-bold text-primary mb-4">üìÑ Content Editor</h2>
              <div class="editor-toolbar flex flex-wrap gap-2 mb-4 p-3 bg-gray-50 rounded-lg">
                <button type="button" data-cmd="bold" title="Bold">
                  <i class="fas fa-bold"></i>
                </button>
                <button type="button" data-cmd="italic" title="Italic">
                  <i class="fas fa-italic"></i>
                </button>
                <button type="button" data-cmd="underline" title="Underline">
                  <i class="fas fa-underline"></i>
                </button>
                <div class="w-px bg-gray-300"></div>
                <button type="button" data-cmd="h2" title="Heading 2">H2</button>
                <button type="button" data-cmd="h3" title="Heading 3">H3</button>
                <div class="w-px bg-gray-300"></div>
                <button type="button" data-cmd="ul" title="Bullet List">
                  <i class="fas fa-list"></i>
                </button>
                <button type="button" data-cmd="ol" title="Numbered List">
                  <i class="fas fa-list-ol"></i>
                </button>
                <button type="button" data-cmd="link" title="Insert Link">
                  <i class="fas fa-link"></i>
                </button>
                <button type="button" id="insertImageBtn" title="Insert Image">
                  <i class="fas fa-image"></i>
                </button>
              </div>
              <div
                id="content"
                contenteditable="true"
                class="prose max-w-none"
                placeholder="Start writing your content..."
              ></div>
            </div>

            <!-- Inline Image Upload -->
            <div class="bg-white rounded-xl shadow p-6">
              <h2 class="text-lg font-bold text-primary mb-4">üñºÔ∏è Insert Image</h2>
              <div class="space-y-3">
                <div>
                  <label class="block text-sm font-medium mb-2">Upload Image</label>
                  <input
                    type="file"
                    id="inlineImageFile"
                    class="w-full px-4 py-2 border rounded-lg"
                    accept="image/*"
                  />
                </div>
                <div class="grid grid-cols-2 gap-3">
                  <button
                    id="uploadInlineBtn"
                    class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-accent transition"
                  >
                    <i class="fas fa-cloud-upload-alt"></i>
                    Upload & Insert
                  </button>
                  <button
                    id="selectInlineBtn"
                    class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition"
                  >
                    <i class="fas fa-image"></i>
                    From Library
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Right: Metadata -->
          <div class="space-y-6">
            <div class="bg-white rounded-xl shadow p-6">
              <h2 class="text-lg font-bold text-primary mb-4">üìã Post Metadata</h2>
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium mb-2">Excerpt</label>
                  <textarea
                    id="postExcerpt"
                    rows="3"
                    class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
                    placeholder="Brief summary"
                  ></textarea>
                </div>
                <div>
                  <label class="block text-sm font-medium mb-2">Date</label>
                  <input type="date" id="postDate" class="w-full px-4 py-2 border rounded-lg" />
                </div>
                <div>
                  <label class="block text-sm font-medium mb-2">Category</label>
                  <select id="postCategory" class="w-full px-4 py-2 border rounded-lg">
                    <option value="wellness">Wellness</option>
                    <option value="sustainability">Sustainability</option>
                    <option value="technology">Technology</option>
                    <option value="lifestyle">Lifestyle</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium mb-2">Tags (comma-separated)</label>
                  <input
                    type="text"
                    id="postTags"
                    class="w-full px-4 py-2 border rounded-lg"
                    placeholder="tag1, tag2, tag3"
                  />
                </div>
                <div>
                  <label class="block text-sm font-medium mb-2">Author</label>
                  <input
                    type="text"
                    id="postAuthor"
                    class="w-full px-4 py-2 border rounded-lg"
                    placeholder="Author name"
                  />
                </div>
                <div>
                  <label class="block text-sm font-medium mb-2">Read Time</label>
                  <input
                    type="text"
                    id="postReadTime"
                    class="w-full px-4 py-2 border rounded-lg"
                    placeholder="5 min read"
                  />
                </div>
              </div>
            </div>

            <!-- Preview -->
            <div class="bg-white rounded-xl shadow p-6">
              <h2 class="text-lg font-bold text-primary mb-4">üëÅÔ∏è Preview</h2>
              <div
                id="postPreview"
                class="text-sm border rounded-lg p-4 bg-gray-50 max-h-64 overflow-auto"
              ></div>
            </div>
          </div>
        </div>
      </div>

      <!-- SEO & META TAB -->
      <div id="seo" class="tab-content">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
          <div class="space-y-6">
            <div class="bg-white rounded-xl shadow p-6">
              <h2 class="text-lg font-bold text-primary mb-4">üîç SEO Meta Tags</h2>
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium mb-2">Meta Description</label>
                  <textarea
                    id="metaDescription"
                    rows="3"
                    maxlength="160"
                    class="w-full px-4 py-2 border rounded-lg"
                    placeholder="160 characters recommended"
                  ></textarea>
                  <span class="text-xs text-gray-500" id="metaDescCount">0/160</span>
                </div>
                <div>
                  <label class="block text-sm font-medium mb-2">Meta Keywords</label>
                  <input
                    type="text"
                    id="metaKeywords"
                    class="w-full px-4 py-2 border rounded-lg"
                    placeholder="keyword1, keyword2, keyword3"
                  />
                </div>
                <div>
                  <label class="block text-sm font-medium mb-2">OG Image URL</label>
                  <input
                    type="text"
                    id="ogImage"
                    class="w-full px-4 py-2 border rounded-lg"
                    placeholder="Open Graph image URL"
                  />
                </div>
                <div>
                  <label class="block text-sm font-medium mb-2">Canonical URL</label>
                  <input
                    type="text"
                    id="canonicalUrl"
                    class="w-full px-4 py-2 border rounded-lg"
                    placeholder="https://calmiqs.com/blog/post-slug"
                  />
                </div>
              </div>
            </div>
          </div>

          <div class="space-y-6">
            <div class="bg-white rounded-xl shadow p-6">
              <h2 class="text-lg font-bold text-primary mb-4">üìã JSON Schema</h2>
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium mb-2">Schema Type</label>
                  <select id="schemaType" class="w-full px-4 py-2 border rounded-lg">
                    <option value="Article">Article</option>
                    <option value="BlogPosting">Blog Post</option>
                    <option value="NewsArticle">News Article</option>
                  </select>
                </div>
                <button
                  id="generateSchemaBtn"
                  class="w-full bg-primary text-white px-4 py-2 rounded-lg hover:bg-accent transition"
                >
                  <i class="fas fa-magic"></i>
                  Generate Schema
                </button>
                <div
                  id="schemaPreview"
                  class="bg-gray-50 p-4 rounded-lg text-xs font-mono overflow-auto max-h-64"
                >
                  { Ready to generate }
                </div>
                <button
                  id="copySchemaBtn"
                  class="w-full bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition"
                >
                  <i class="fas fa-copy"></i>
                  Copy Schema
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- IMAGES TAB -->
      <div id="images" class="tab-content">
        <div class="bg-white rounded-xl shadow p-6">
          <h2 class="text-2xl font-bold text-primary mb-6">üñºÔ∏è Image Library</h2>
          <div id="imageLibraryGrid" class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="col-span-full text-center py-8 text-gray-500">Loading images...</div>
          </div>
        </div>
      </div>

      <!-- SETTINGS TAB -->
      <div id="settings" class="tab-content">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
          <div class="bg-white rounded-xl shadow p-6">
            <h2 class="text-lg font-bold text-primary mb-4">üîß Site Configuration</h2>
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium mb-2">Site URL</label>
                <input
                  type="text"
                  id="siteUrl"
                  class="w-full px-4 py-2 border rounded-lg"
                  value="https://calmiqs.pages.dev"
                />
              </div>
              <div>
                <label class="block text-sm font-medium mb-2">Site Title</label>
                <input
                  type="text"
                  id="siteTitle"
                  class="w-full px-4 py-2 border rounded-lg"
                  value="Calmiqs ‚Äì Wellness & Eco Balance"
                />
              </div>
              <div>
                <label class="block text-sm font-medium mb-2">Site Description</label>
                <textarea id="siteDescription" class="w-full px-4 py-2 border rounded-lg" rows="3">
Explore AI-powered wellness tools and eco-friendly insights</textarea
                >
              </div>
              <button
                id="saveSiteSettings"
                class="w-full bg-primary text-white px-4 py-2 rounded-lg hover:bg-accent transition"
              >
                <i class="fas fa-save"></i>
                Save Settings
              </button>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Image Library Modal -->
    <div
      id="imageLibraryModal"
      class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
    >
      <div class="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-auto">
        <div class="flex justify-between items-center p-6 border-b">
          <h3 class="text-xl font-bold text-primary">üìö Image Library</h3>
          <button id="closeLibraryModal" class="text-2xl text-gray-400 hover:text-gray-600">
            √ó
          </button>
        </div>
        <div class="p-6">
          <div id="libraryGridModal" class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="col-span-full text-center py-8 text-gray-500">Loading library...</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Post Library Modal -->
    <div
      id="postLibraryModal"
      class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
    >
      <div class="bg-white rounded-xl max-w-2xl w-full max-h-[90vh] overflow-auto">
        <div class="flex justify-between items-center p-6 border-b">
          <h3 class="text-xl font-bold text-primary">üìö Posts Library</h3>
          <button id="closePostLibraryModal" class="text-2xl text-gray-400 hover:text-gray-600">
            √ó
          </button>
        </div>
        <div class="p-6">
          <div id="postLibraryList">
            <div class="text-center py-8 text-gray-500">Loading posts...</div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const WORKER_BASE = "https://calmiqs-images-worker.techaipet.workers.dev";
      const ADMIN_TOKEN = window.CALMIQS_ADMIN_TOKEN;

      let currentPost = null;
      let selectedHeroImage = null;

      // Auth fetch helper
      async function authFetch(url, opts = {}) {
        opts.headers = opts.headers || {};
        opts.headers["X-Admin-Token"] = ADMIN_TOKEN;
        return fetch(url, opts);
      }

      // Generate slug from title
      function generateSlug(title) {
        return title
          .toLowerCase()
          .replace(/[^a-z0-9]+/g, "-")
          .replace(/(^-|-$)/g, "");
      }

      // Update preview
      function updatePreview() {
        const title = document.getElementById("postTitle").value || "Untitled";
        const content = document.getElementById("content").innerHTML || "<p>No content</p>";
        const preview = document.getElementById("postPreview");
        preview.innerHTML = `<h3 class="font-bold text-primary mb-2">${title}</h3><div class="text-xs">${content.substring(
          0,
          300
        )}...</div>`;
      }

      // Tab navigation
      document.querySelectorAll(".tab-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          const tabName = btn.dataset.tab;
          document.querySelectorAll(".tab-content").forEach((el) => el.classList.remove("active"));
          document.querySelectorAll(".tab-btn").forEach((el) => {
            el.classList.remove("border-primary", "text-primary");
            el.classList.add("border-transparent", "text-gray-600");
          });
          document.getElementById(tabName).classList.add("active");
          btn.classList.remove("border-transparent", "text-gray-600");
          btn.classList.add("border-primary", "text-primary");

          if (tabName === "images") loadImageLibraryTab();
        });
      });

      // Editor toolbar
      document.querySelectorAll(".editor-toolbar button").forEach((btn) => {
        btn.addEventListener("click", (e) => {
          e.preventDefault();
          const cmd = btn.dataset.cmd;

          if (cmd === "link") {
            const url = prompt("Enter URL:");
            if (url) document.execCommand("createLink", false, url);
          } else if (cmd === "h2" || cmd === "h3") {
            document.execCommand("formatBlock", false, cmd);
          } else if (cmd === "ul") {
            document.execCommand("insertUnorderedList", false, null);
          } else if (cmd === "ol") {
            document.execCommand("insertOrderedList", false, null);
          } else if (cmd) {
            document.execCommand(cmd, false, null);
          }

          updatePreview();
          document.getElementById("content").focus();
        });
      });

      // Title input
      document.getElementById("postTitle").addEventListener("input", () => {
        const slug = generateSlug(document.getElementById("postTitle").value);
        document.getElementById("postSlug").value = slug;
        updatePreview();
      });

      // Content input
      document.getElementById("content").addEventListener("input", updatePreview);

      // Meta description counter
      document.getElementById("metaDescription").addEventListener("input", (e) => {
        document.getElementById("metaDescCount").textContent = `${e.target.value.length}/160`;
      });

      // New Post
      document.getElementById("newPostBtn").addEventListener("click", () => {
        document.getElementById("postTitle").value = "";
        document.getElementById("postSlug").value = "";
        document.getElementById("postExcerpt").value = "";
        document.getElementById("postDate").value = new Date().toISOString().split("T")[0];
        document.getElementById("content").innerHTML = "";
        document.getElementById("postCategory").value = "wellness";
        document.getElementById("postTags").value = "";
        document.getElementById("postAuthor").value = "Calmiqs Team";
        document.getElementById("postReadTime").value = "";
        document.getElementById("metaDescription").value = "";
        document.getElementById("metaKeywords").value = "";
        document.getElementById("canonicalUrl").value = "";
        document.getElementById("heroImageFile").value = "";
        document.getElementById("heroAlt").value = "";
        document.getElementById("heroPreview").innerHTML = "";
        selectedHeroImage = null;
        currentPost = null;
        updatePreview();
      });

      // Save Post
      document.getElementById("savePostBtn").addEventListener("click", async () => {
        const title = document.getElementById("postTitle").value.trim();
        if (!title) return alert("Enter post title");

        const postData = {
          title,
          slug: generateSlug(title),
          excerpt: document.getElementById("postExcerpt").value,
          date: document.getElementById("postDate").value,
          category: document.getElementById("postCategory").value,
          tags: document
            .getElementById("postTags")
            .value.split(",")
            .map((t) => t.trim())
            .filter((t) => t),
          author: document.getElementById("postAuthor").value,
          readTime: document.getElementById("postReadTime").value,
          content: document.getElementById("content").innerHTML,
          image: selectedHeroImage || "",
          imageAlt: document.getElementById("heroAlt").value,
          metaDescription: document.getElementById("metaDescription").value,
          metaKeywords: document.getElementById("metaKeywords").value,
          ogImage: document.getElementById("ogImage").value,
          canonicalUrl: document.getElementById("canonicalUrl").value,
        };

        try {
          const res = await authFetch(`${WORKER_BASE}/api/posts`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(postData),
          });
          const result = await res.json();
          if (res.ok) {
            alert("‚úÖ Post saved successfully!");
          } else {
            alert("‚ùå " + (result.error || "Save failed"));
          }
        } catch (err) {
          console.error(err);
          alert("‚ùå Save failed: " + err.message);
        }
      });

      // Load Post
      document.getElementById("loadPostBtn").addEventListener("click", () => {
        const modal = document.getElementById("postLibraryModal");
        modal.classList.remove("hidden");
        loadPostLibrary();
      });

      async function loadPostLibrary() {
        try {
          const res = await authFetch(`${WORKER_BASE}/api/posts`);
          const data = await res.json();
          const list = document.getElementById("postLibraryList");
          list.innerHTML = "";

          let postsArray = [];
          if (data.success && data.posts) {
            postsArray = data.posts;
          } else if (Array.isArray(data)) {
            postsArray = data;
          } else if (typeof data === "object") {
            postsArray = Object.entries(data).map(([slug, post]) => ({
              ...post,
              slug: slug,
            }));
          }

          if (postsArray.length === 0) {
            list.innerHTML = "<p class='text-center text-gray-500 py-8'>No posts yet</p>";
            return;
          }

          postsArray.forEach((post) => {
            const el = document.createElement("div");
            el.className = "p-4 border-b hover:bg-gray-50 cursor-pointer transition";
            el.innerHTML = `
              <div class="font-semibold text-primary">${post.title}</div>
              <div class="text-xs text-gray-500">${post.slug} ‚Ä¢ ${new Date(
              post.date
            ).toLocaleDateString()}</div>
            `;
            el.addEventListener("click", () => {
              loadPostToEditor(post);
              document.getElementById("postLibraryModal").classList.add("hidden");
            });
            list.appendChild(el);
          });
        } catch (err) {
          console.error(err);
          document.getElementById("postLibraryList").innerHTML =
            "<p class='text-center text-red-600 py-8'>Failed to load posts</p>";
        }
      }

      function loadPostToEditor(post) {
        document.getElementById("postTitle").value = post.title;
        document.getElementById("postExcerpt").value = post.excerpt || "";
        document.getElementById("postDate").value = post.date;
        document.getElementById("content").innerHTML = post.content || "";
        document.getElementById("postCategory").value = post.category || "wellness";
        document.getElementById("postTags").value = (post.tags || []).join(", ");
        document.getElementById("postAuthor").value = post.author || "";
        document.getElementById("postReadTime").value = post.readTime || "";
        document.getElementById("metaDescription").value = post.metaDescription || "";
        document.getElementById("metaKeywords").value = post.metaKeywords || "";
        document.getElementById("canonicalUrl").value = post.canonicalUrl || "";
        document.getElementById("heroAlt").value = post.imageAlt || "";
        document.getElementById("postSlug").value = post.slug;
        selectedHeroImage = post.image;

        if (post.image) {
          document.getElementById("heroPreview").innerHTML = `<img src="${post.image}" alt="${
            post.imageAlt || "Hero"
          }" class="max-w-full rounded-lg shadow-md" />`;
        }

        currentPost = post;
        updatePreview();
      }

      // Delete Post
      document.getElementById("deletePostBtn").addEventListener("click", async () => {
        const slug = document.getElementById("postSlug").value;
        if (!slug) return alert("No post selected");
        if (!confirm("Delete this post? This cannot be undone.")) return;

        try {
          const res = await authFetch(`${WORKER_BASE}/api/posts/${slug}`, { method: "DELETE" });
          if (res.ok) {
            alert("‚úÖ Post deleted");
            document.getElementById("newPostBtn").click();
          } else {
            alert("‚ùå Delete failed");
          }
        } catch (err) {
          alert("‚ùå Error: " + err.message);
        }
      });

      // Upload Hero Image
      document.getElementById("uploadHeroBtn").addEventListener("click", async () => {
        const file = document.getElementById("heroImageFile").files[0];
        if (!file) return alert("Choose an image");

        const form = new FormData();
        form.append("file", file);
        form.append("alt", document.getElementById("heroAlt").value || file.name);
        form.append("title", document.getElementById("postTitle").value || file.name);

        try {
          document.getElementById("uploadHeroBtn").disabled = true;
          document.getElementById("uploadHeroBtn").innerHTML =
            '<i class="fas fa-spinner fa-spin"></i> Uploading...';

          const res = await authFetch(`${WORKER_BASE}/upload`, {
            method: "POST",
            body: form,
          });

          const data = await res.json();
          console.log("Upload response:", data);

          if (res.ok && data.success) {
            // The worker returns { success: true, url: ..., r2Key: ..., metadata: ... }
            const imageUrl = data.url;
            selectedHeroImage = imageUrl;

            document.getElementById("heroPreview").innerHTML = `<img src="${imageUrl}" alt="${
              data.metadata?.alt || "Hero image"
            }" class="max-w-full rounded-lg shadow-md" 
                    onerror="this.onerror=null; this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22400%22 height=%22300%22><rect width=%22400%22 height=%22300%22 fill=%22%23f0f0f0%22/><text x=%2250%25%22 y=%2250%25%22 fill=%22%23999%22 text-anchor=%22middle%22 dy=%22.3em%22>Image uploaded</text></svg>';" />`;

            alert("‚úÖ Hero image uploaded successfully!");
          } else {
            throw new Error(data.error || "Upload failed");
          }
        } catch (err) {
          console.error("Upload error:", err);
          alert("‚ùå Upload failed: " + err.message);
        } finally {
          document.getElementById("uploadHeroBtn").disabled = false;
          document.getElementById("uploadHeroBtn").innerHTML =
            '<i class="fas fa-cloud-upload-alt"></i> Upload';
        }
      });

      // Select Hero from Library
      document.getElementById("selectHeroBtn").addEventListener("click", () => {
        const modal = document.getElementById("imageLibraryModal");
        modal.classList.remove("hidden");
        loadImageLibraryForHero();
      });

      async function loadImageLibraryForHero() {
        try {
          console.log("Loading image library for hero...");
          const res = await authFetch(`${WORKER_BASE}/list`);

          if (!res.ok) {
            throw new Error(`HTTP ${res.status}: ${res.statusText}`);
          }

          const data = await res.json();
          console.log("Library data:", data);

          const grid = document.getElementById("libraryGridModal");
          grid.innerHTML = "";

          if (!data.images || data.images.length === 0) {
            grid.innerHTML =
              "<div class='col-span-full text-center text-gray-500 py-8'>No images in library. Upload some images first!</div>";
            return;
          }

          data.images.forEach((img) => {
            const thumb = document.createElement("div");
            thumb.className = "relative group cursor-pointer";

            // Construct proper image URL
            const imageUrl = `${WORKER_BASE}/files/${encodeURIComponent(img.r2Key)}`;
            console.log("Image URL:", imageUrl);

            thumb.innerHTML = `
              <img src="${imageUrl}" alt="${img.alt || ""}" 
                   class="w-full h-32 object-cover rounded hover:opacity-75 transition"
                   onerror="this.onerror=null; this.parentElement.innerHTML='<div class=\\'w-full h-32 bg-gray-200 rounded flex items-center justify-center text-xs text-gray-500\\'>Load error</div>';" />
              <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-30 transition flex items-center justify-center">
                <span class="text-white opacity-0 group-hover:opacity-100 font-medium">Select</span>
              </div>
              <div class="text-xs text-center mt-1 truncate">${
                img.title || img.filename || "Image"
              }</div>
            `;

            thumb.addEventListener("click", () => {
              selectedHeroImage = imageUrl;
              document.getElementById("heroPreview").innerHTML = `<img src="${imageUrl}" alt="${
                img.alt || "Hero"
              }" class="max-w-full rounded-lg shadow-md" />`;
              document.getElementById("heroAlt").value = img.alt || "";
              document.getElementById("imageLibraryModal").classList.add("hidden");
              alert("‚úÖ Hero image selected");
            });

            grid.appendChild(thumb);
          });
        } catch (err) {
          console.error("Library load error:", err);
          document.getElementById(
            "libraryGridModal"
          ).innerHTML = `<div class='col-span-full text-center text-red-600 py-8'>Failed to load library<br><span class="text-xs">${err.message}</span></div>`;
        }
      }

      // Insert Image Button (from library)
      document.getElementById("insertImageBtn").addEventListener("click", () => {
        const modal = document.getElementById("imageLibraryModal");
        modal.classList.remove("hidden");
        loadImageLibraryForInline();
      });

      // Select Inline Image from Library
      document.getElementById("selectInlineBtn").addEventListener("click", () => {
        const modal = document.getElementById("imageLibraryModal");
        modal.classList.remove("hidden");
        loadImageLibraryForInline();
      });

      // Upload Inline Image
      document.getElementById("uploadInlineBtn").addEventListener("click", async () => {
        const file = document.getElementById("inlineImageFile").files[0];
        if (!file) return alert("Choose an image");

        const form = new FormData();
        form.append("file", file);
        form.append("alt", file.name);
        form.append("title", file.name);

        try {
          document.getElementById("uploadInlineBtn").disabled = true;
          document.getElementById("uploadInlineBtn").innerHTML =
            '<i class="fas fa-spinner fa-spin"></i> Uploading...';

          const res = await authFetch(`${WORKER_BASE}/upload`, {
            method: "POST",
            body: form,
          });

          const data = await res.json();
          console.log("Inline upload response:", data);

          if (res.ok && data.success) {
            const imageUrl = data.url;

            // Insert image into editor
            const imgElement = document.createElement("img");
            imgElement.src = imageUrl;
            imgElement.alt = data.metadata?.alt || file.name;
            imgElement.className = "inline-img my-4 rounded-lg shadow-md";
            imgElement.style.maxWidth = "100%";
            imgElement.style.height = "auto";

            document.getElementById("content").appendChild(imgElement);
            document.getElementById("inlineImageFile").value = "";
            updatePreview();

            alert("‚úÖ Image inserted successfully!");
          } else {
            throw new Error(data.error || "Upload failed");
          }
        } catch (err) {
          console.error("Inline upload error:", err);
          alert("‚ùå Upload failed: " + err.message);
        } finally {
          document.getElementById("uploadInlineBtn").disabled = false;
          document.getElementById("uploadInlineBtn").innerHTML =
            '<i class="fas fa-cloud-upload-alt"></i> Upload & Insert';
        }
      });

      async function loadImageLibraryForInline() {
        try {
          console.log("Loading image library for inline...");
          const res = await authFetch(`${WORKER_BASE}/list`);

          if (!res.ok) {
            throw new Error(`HTTP ${res.status}: ${res.statusText}`);
          }

          const data = await res.json();
          console.log("Library data:", data);

          const grid = document.getElementById("libraryGridModal");
          grid.innerHTML = "";

          if (!data.images || data.images.length === 0) {
            grid.innerHTML =
              "<div class='col-span-full text-center text-gray-500 py-8'>No images in library. Upload some images first!</div>";
            return;
          }

          data.images.forEach((img) => {
            const thumb = document.createElement("div");
            thumb.className = "relative group cursor-pointer";

            const imageUrl = `${WORKER_BASE}/files/${encodeURIComponent(img.r2Key)}`;

            thumb.innerHTML = `
              <img src="${imageUrl}" alt="${img.alt || ""}" 
                   class="w-full h-32 object-cover rounded hover:opacity-75 transition"
                   onerror="this.onerror=null; this.parentElement.innerHTML='<div class=\\'w-full h-32 bg-gray-200 rounded flex items-center justify-center text-xs text-gray-500\\'>Load error</div>';" />
              <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-30 transition flex items-center justify-center">
                <span class="text-white opacity-0 group-hover:opacity-100 font-medium">Insert</span>
              </div>
              <div class="text-xs text-center mt-1 truncate">${
                img.title || img.filename || "Image"
              }</div>
            `;

            thumb.addEventListener("click", () => {
              const imgElement = document.createElement("img");
              imgElement.src = imageUrl;
              imgElement.alt = img.alt || "";
              imgElement.className = "inline-img my-4 rounded-lg shadow-md";
              imgElement.style.maxWidth = "100%";
              imgElement.style.height = "auto";

              document.getElementById("content").appendChild(imgElement);
              document.getElementById("imageLibraryModal").classList.add("hidden");
              updatePreview();
            });

            grid.appendChild(thumb);
          });
        } catch (err) {
          console.error("Library load error:", err);
          document.getElementById(
            "libraryGridModal"
          ).innerHTML = `<div class='col-span-full text-center text-red-600 py-8'>Failed to load library<br><span class="text-xs">${err.message}</span></div>`;
        }
      }

      // Load Image Library Tab
      async function loadImageLibraryTab() {
        try {
          console.log("Loading images tab...");
          const res = await authFetch(`${WORKER_BASE}/list`);

          if (!res.ok) {
            throw new Error(`HTTP ${res.status}: ${res.statusText}`);
          }

          const data = await res.json();
          console.log("Images tab data:", data);

          const grid = document.getElementById("imageLibraryGrid");
          grid.innerHTML = "";

          if (!data.images || data.images.length === 0) {
            grid.innerHTML =
              "<div class='col-span-full text-center text-gray-500 py-8'>No images uploaded yet. Upload images from the Editor tab!</div>";
            return;
          }

          data.images.forEach((img) => {
            const card = document.createElement("div");
            card.className =
              "bg-white rounded-lg overflow-hidden shadow hover:shadow-lg transition";

            const imageUrl = `${WORKER_BASE}/files/${encodeURIComponent(img.r2Key)}`;

            card.innerHTML = `
              <img src="${imageUrl}" alt="${img.alt || ""}" class="w-full h-40 object-cover"
                   onerror="this.onerror=null; this.parentElement.innerHTML='<div class=\\'w-full h-40 bg-gray-200 flex items-center justify-center text-xs text-gray-500\\'>Load error</div>';" />
              <div class="p-3">
                <p class="text-sm font-medium text-gray-700 truncate">${
                  img.title || img.filename || "Image"
                }</p>
                <p class="text-xs text-gray-500 truncate">${img.alt || "No alt text"}</p>
                <p class="text-xs text-gray-400 mt-1">${new Date(
                  img.uploadedAt || img.createdAt
                ).toLocaleDateString()}</p>
              </div>
            `;
            grid.appendChild(card);
          });
        } catch (err) {
          console.error("Images tab error:", err);
          document.getElementById(
            "imageLibraryGrid"
          ).innerHTML = `<div class='col-span-full text-center text-red-600 py-8'>Failed to load images<br><span class="text-xs">${err.message}</span></div>`;
        }
      }

      // Generate Schema
      document.getElementById("generateSchemaBtn").addEventListener("click", () => {
        const schemaType = document.getElementById("schemaType").value;
        const title = document.getElementById("postTitle").value || "Untitled";
        const excerpt = document.getElementById("postExcerpt").value || "";
        const author = document.getElementById("postAuthor").value || "Calmiqs Team";
        const date = document.getElementById("postDate").value || new Date().toISOString();

        const schema = {
          "@context": "https://schema.org",
          "@type": schemaType,
          headline: title,
          description: excerpt,
          author: { "@type": "Person", name: author },
          datePublished: date,
          image:
            document.getElementById("ogImage").value ||
            selectedHeroImage ||
            "https://calmiqs.pages.dev/assets/logo.svg",
          publisher: {
            "@type": "Organization",
            name: "Calmiqs",
            logo: "https://calmiqs.pages.dev/assets/logo.svg",
          },
        };

        document.getElementById("schemaPreview").textContent = JSON.stringify(schema, null, 2);
      });

      // Copy Schema
      document.getElementById("copySchemaBtn").addEventListener("click", () => {
        const schema = document.getElementById("schemaPreview").textContent;
        navigator.clipboard
          .writeText(schema)
          .then(() => {
            alert("‚úÖ Schema copied to clipboard");
          })
          .catch(() => {
            alert("Failed to copy");
          });
      });

      // Save Site Settings
      document.getElementById("saveSiteSettings").addEventListener("click", () => {
        const settings = {
          siteUrl: document.getElementById("siteUrl").value,
          siteTitle: document.getElementById("siteTitle").value,
          siteDescription: document.getElementById("siteDescription").value,
        };
        localStorage.setItem("calmiqsSiteSettings", JSON.stringify(settings));
        alert("‚úÖ Settings saved");
      });

      // Close modals
      document.getElementById("closeLibraryModal").addEventListener("click", () => {
        document.getElementById("imageLibraryModal").classList.add("hidden");
      });

      document.getElementById("closePostLibraryModal").addEventListener("click", () => {
        document.getElementById("postLibraryModal").classList.add("hidden");
      });

      // Close modals on backdrop click
      document.getElementById("imageLibraryModal").addEventListener("click", (e) => {
        if (e.target.id === "imageLibraryModal") {
          e.target.classList.add("hidden");
        }
      });

      document.getElementById("postLibraryModal").addEventListener("click", (e) => {
        if (e.target.id === "postLibraryModal") {
          e.target.classList.add("hidden");
        }
      });

      // Logout
      document.getElementById("logoutBtn").addEventListener("click", () => {
        localStorage.removeItem("calmiqsAuth");
        sessionStorage.removeItem("calmiqsAuth");
        localStorage.removeItem("isAdmin");
        sessionStorage.removeItem("isAdmin");
        window.location.href = "/";
      });

      // Initialize
      document.getElementById("postDate").valueAsDate = new Date();
      const settings = JSON.parse(localStorage.getItem("calmiqsSiteSettings") || "{}");
      if (settings.siteUrl) document.getElementById("siteUrl").value = settings.siteUrl;
      if (settings.siteTitle) document.getElementById("siteTitle").value = settings.siteTitle;
      if (settings.siteDescription)
        document.getElementById("siteDescription").value = settings.siteDescription;
    </script>
  </body>
</html>
