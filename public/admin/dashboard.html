<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Calmiqs Editor - Content Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#4FA49A",
              accent: "#FFD580",
              tech: "#5A67D8",
            },
            fontFamily: { sans: ["Poppins", "sans-serif"] },
          },
        },
      };
    </script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }
      .editor-toolbar button {
        padding: 0.5rem;
        border: 1px solid #d1d5db;
        background: white;
        border-radius: 0.375rem;
        cursor: pointer;
        transition: all 0.2s;
      }
      .editor-toolbar button:hover {
        background: #f3f4f6;
        border-color: #4fa49a;
      }
      #content {
        min-height: 400px;
        padding: 1rem;
        border: 2px solid #d1d5db;
        border-radius: 0.5rem;
        outline: none;
      }
      #content:focus {
        border-color: #4fa49a;
        box-shadow: 0 0 0 3px rgba(79, 164, 154, 0.1);
      }
      .modal-hidden {
        display: none !important;
      }
      /* Image wrapper styling */
      .inline-image-wrapper {
        position: relative;
        display: inline-block;
        margin: 1rem 0;
      }

      .inline-img {
        max-width: 100%;
        height: auto;
        display: block;
        border-radius: 0.5rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        cursor: pointer;
        transition: opacity 0.2s;
      }

      .inline-img:hover {
        opacity: 0.9;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .inline-img.selected {
        outline: 3px solid #4fa49a;
        outline-offset: 2px;
      }

      /* Image toolbar */
      #imageFormattingToolbar {
        position: absolute;
        top: -50px;
        left: 0;
        background: #333;
        color: white;
        padding: 0.5rem;
        border-radius: 0.375rem;
        display: flex;
        gap: 0.5rem;
        z-index: 1000;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      }

      #imageFormattingToolbar input,
      #imageFormattingToolbar select {
        padding: 0.25rem;
        border-radius: 0.25rem;
        border: none;
        font-size: 0.75rem;
      }

      #imageFormattingToolbar button {
        background: #666;
        color: white;
        border: none;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        cursor: pointer;
        font-size: 0.75rem;
        transition: background 0.2s;
      }

      #imageFormattingToolbar button:hover {
        background: #555;
      }

      #imageFormattingToolbar button.delete {
        background: #dc2626;
      }

      #imageFormattingToolbar button.delete:hover {
        background: #b91c1c;
      }

      /* Content editor adjustments */
      #content img {
        max-width: 100%;
        height: auto;
        margin: 1rem 0;
        border-radius: 0.5rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      #content .inline-image-wrapper {
        position: relative;
        margin: 1rem 0;
      }

      #content .inline-image-wrapper img {
        margin: 0;
      }

      /* Floating images */
      #content .inline-image-wrapper.align-left {
        float: left;
        margin-right: 1rem;
      }

      #content .inline-image-wrapper.align-right {
        float: right;
        margin-left: 1rem;
      }

      #content .inline-image-wrapper.align-center {
        text-align: center;
        float: none;
        margin: 1rem auto;
      }
      #formatIndicator {
        font-size: 0.75rem;
        color: #6b7280;
        margin-bottom: 0.5rem;
        padding: 0.25rem 0.5rem;
        background: #f3f4f6;
        border-radius: 0.25rem;
        display: inline-block;
      }

      #formatIndicator.active {
        background: #4fa49a;
        color: white;
      }
    </style>
  </head>

  <body class="bg-gray-50 font-sans">
    <script>
      window.CALMIQS_ADMIN_TOKEN = "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Hadia@2017_Ayesha@2007";
    </script>
    <!-- ADD THIS AT THE VERY TOP OF dashboard.html (before the header) -->

    <!-- AUTH WALL - BLOCK UNAUTHORIZED ACCESS -->
    <script>
      // Check if user is authenticated
      function checkAuth() {
        const isAuth =
          localStorage.getItem("calmiqsAuth") === "true" ||
          sessionStorage.getItem("calmiqsAuth") === "true" ||
          localStorage.getItem("isAdmin") === "true" ||
          sessionStorage.getItem("isAdmin") === "true";

        if (!isAuth) {
          // Redirect to login page or home
          window.location.href = "/";
          return false;
        }
        return true;
      }

      // Run auth check immediately
      if (!checkAuth()) {
        document.body.innerHTML =
          '<div style="display:flex;align-items:center;justify-content:center;height:100vh;"><p>Redirecting to login...</p></div>';
      }
    </script>
    <!-- ============================================ -->
    <!-- FIXED LOGOUT BUTTON IN HEADER -->
    <!-- ============================================ -->

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const logoutBtn = document.getElementById("logoutBtn");
        if (logoutBtn) {
          logoutBtn.addEventListener("click", () => {
            // Clear all auth tokens
            localStorage.removeItem("calmiqsAuth");
            sessionStorage.removeItem("calmiqsAuth");
            localStorage.removeItem("isAdmin");
            sessionStorage.removeItem("isAdmin");
            localStorage.removeItem("calmiqsDraft");
            localStorage.removeItem("calmiqsSiteSettings");

            // Redirect to home page
            window.location.href = "/";
          });
        }
      });
    </script>
    <!-- Header -->
    <header class="bg-white border-b sticky top-0 z-50 shadow-sm">
      <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
        <div class="flex items-center gap-4">
          <a href="/" class="flex items-center gap-2">
            <img src="/assets/logo.svg" alt="Calmiqs Logo" class="h-8 w-8" />
            <span class="text-2xl font-bold text-primary">Calmiqs Editor</span>
          </a>
        </div>
        <div class="flex items-center gap-3">
          <a
            href="/admin/admin-comments.html"
            class="px-4 py-2 text-gray-700 hover:text-primary transition"
          >
            üí¨ Comments
          </a>
          <button
            id="logoutBtn"
            class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg transition"
          >
            Logout
          </button>
        </div>
      </div>
    </header>

    <!-- Tabs Navigation -->
    <nav class="bg-white border-b sticky top-16 z-40 shadow-sm">
      <div class="max-w-7xl mx-auto px-6 flex gap-4 overflow-x-auto">
        <button
          class="tab-btn py-4 px-4 border-b-2 border-primary text-primary font-medium"
          data-tab="editor"
        >
          üìù Editor
        </button>
        <button
          class="tab-btn py-4 px-4 border-b-2 border-transparent text-gray-600 hover:text-gray-900"
          data-tab="seo"
        >
          üîç SEO & Meta
        </button>
        <button
          class="tab-btn py-4 px-4 border-b-2 border-transparent text-gray-600 hover:text-gray-900"
          data-tab="images"
        >
          üñºÔ∏è Images
        </button>
        <button
          class="tab-btn py-4 px-4 border-b-2 border-transparent text-gray-600 hover:text-gray-900"
          data-tab="settings"
        >
          ‚öôÔ∏è Settings
        </button>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-6 py-8">
      <!-- EDITOR TAB -->
      <div id="editor" class="tab-content active">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
          <!-- Left: Editor -->
          <div class="lg:col-span-2 space-y-6">
            <!-- Post Management -->
            <div class="bg-white rounded-xl shadow p-6">
              <h2 class="text-xl font-bold text-primary mb-4">üìã Post Management</h2>
              <div class="grid grid-cols-2 gap-3 mb-6">
                <button
                  id="newPostBtn"
                  class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-accent transition"
                >
                  <i class="fas fa-plus"></i>
                  New Post
                </button>
                <button
                  id="loadPostBtn"
                  class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition"
                >
                  <i class="fas fa-folder-open"></i>
                  Load Post
                </button>
                <button
                  id="savePostBtn"
                  class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition"
                >
                  <i class="fas fa-save"></i>
                  Save Post
                </button>
                <button
                  id="deletePostBtn"
                  class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition"
                >
                  <i class="fas fa-trash"></i>
                  Delete Post
                </button>
              </div>
              <div class="space-y-3">
                <div>
                  <label class="block text-sm font-medium mb-2">Post Slug</label>
                  <input
                    type="text"
                    id="postSlug"
                    readonly
                    class="w-full px-4 py-2 border rounded-lg bg-gray-50"
                  />
                </div>
              </div>
            </div>

            <!-- Title -->
            <div class="bg-white rounded-xl shadow p-6">
              <label class="block text-sm font-medium mb-2">Post Title *</label>
              <input
                type="text"
                id="postTitle"
                class="w-full px-4 py-2 border rounded-lg text-2xl font-bold focus:outline-none focus:ring-2 focus:ring-primary"
                placeholder="Enter your post title..."
              />
            </div>

            <!-- Hero Image -->
            <div class="bg-white rounded-xl shadow p-6">
              <h2 class="text-lg font-bold text-primary mb-4">üñºÔ∏è Hero Image</h2>
              <div class="space-y-3">
                <div>
                  <label class="block text-sm font-medium mb-2">Upload Hero Image</label>
                  <input
                    type="file"
                    id="heroImageFile"
                    class="w-full px-4 py-2 border rounded-lg"
                    accept="image/*"
                  />
                </div>
                <div>
                  <label class="block text-sm font-medium mb-2">Image Alt Text</label>
                  <input
                    type="text"
                    id="heroAlt"
                    class="w-full px-4 py-2 border rounded-lg"
                    placeholder="Describe the image for accessibility"
                  />
                </div>
                <div class="grid grid-cols-2 gap-3">
                  <button
                    id="uploadHeroBtn"
                    class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-accent transition"
                  >
                    <i class="fas fa-cloud-upload-alt"></i>
                    Upload
                  </button>
                  <button
                    id="selectHeroBtn"
                    class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition"
                  >
                    <i class="fas fa-image"></i>
                    From Library
                  </button>
                </div>
                <div id="heroPreview" class="mt-4"></div>
              </div>
            </div>

            <!-- Content Editor -->
            <!-- Content Editor with better styling -->
            <div class="bg-white rounded-xl shadow p-6">
              <h2 class="text-lg font-bold text-primary mb-4">üìÑ Content Editor</h2>

              <!-- Formatting indicator -->
              <div
                id="formatIndicator"
                style="font-size: 0.75rem; color: #6b7280; margin-bottom: 0.5rem"
              >
                Format: Plain
              </div>

              <div class="editor-toolbar flex flex-wrap gap-2 mb-4 p-3 bg-gray-50 rounded-lg">
                <button type="button" data-cmd="bold" title="Bold (Ctrl+B)">
                  <i class="fas fa-bold"></i>
                </button>
                <button type="button" data-cmd="italic" title="Italic (Ctrl+I)">
                  <i class="fas fa-italic"></i>
                </button>
                <button type="button" data-cmd="underline" title="Underline (Ctrl+U)">
                  <i class="fas fa-underline"></i>
                </button>
                <div class="w-px bg-gray-300"></div>
                <button type="button" data-cmd="h2" title="Heading 2">H2</button>
                <button type="button" data-cmd="h3" title="Heading 3">H3</button>
                <button type="button" data-cmd="h4" title="Heading 4">H4</button>
                <button type="button" data-cmd="p" title="Paragraph">
                  <i class="fas fa-align-left"></i>
                </button>
                <div class="w-px bg-gray-300"></div>
                <button type="button" data-cmd="ul" title="Bullet List">
                  <i class="fas fa-list"></i>
                </button>
                <button type="button" data-cmd="ol" title="Numbered List">
                  <i class="fas fa-list-ol"></i>
                </button>
                <button type="button" data-cmd="indent" title="Increase Indent">
                  <i class="fas fa-indent"></i>
                </button>
                <button type="button" data-cmd="outdent" title="Decrease Indent">
                  <i class="fas fa-outdent"></i>
                </button>
                <div class="w-px bg-gray-300"></div>
                <button type="button" data-cmd="link" title="Insert Link">
                  <i class="fas fa-link"></i>
                </button>
                <button type="button" id="insertImageBtn" title="Insert Image">
                  <i class="fas fa-image"></i>
                </button>
                <button type="button" id="htmlViewBtn" title="Toggle HTML View">
                  <i class="fas fa-code"></i>
                </button>
              </div>

              <div
                id="content"
                contenteditable="true"
                class="prose max-w-none"
                style="
                  min-height: 400px;
                  padding: 1rem;
                  border: 2px solid #d1d5db;
                  border-radius: 0.5rem;
                  outline: none;
                  line-height: 1.6;
                "
                placeholder="Start writing your content..."
              ></div>
            </div>

            <!-- Inline Image Upload -->
            <div class="bg-white rounded-xl shadow p-6">
              <h2 class="text-lg font-bold text-primary mb-4">üñºÔ∏è Insert Image</h2>
              <div class="space-y-3">
                <div>
                  <label class="block text-sm font-medium mb-2">Upload Image</label>
                  <input
                    type="file"
                    id="inlineImageFile"
                    class="w-full px-4 py-2 border rounded-lg"
                    accept="image/*"
                  />
                </div>
                <div class="grid grid-cols-2 gap-3">
                  <button
                    id="uploadInlineBtn"
                    class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-accent transition"
                  >
                    <i class="fas fa-cloud-upload-alt"></i>
                    Upload & Insert
                  </button>
                  <button
                    id="selectInlineBtn"
                    class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition"
                  >
                    <i class="fas fa-image"></i>
                    From Library
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Right: Metadata -->
          <div class="space-y-6">
            <div class="bg-white rounded-xl shadow p-6">
              <h2 class="text-lg font-bold text-primary mb-4">üìã Post Metadata</h2>
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium mb-2">Excerpt</label>
                  <textarea
                    id="postExcerpt"
                    rows="3"
                    class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
                    placeholder="Brief summary"
                  ></textarea>
                </div>
                <div>
                  <label class="block text-sm font-medium mb-2">Date</label>
                  <input type="date" id="postDate" class="w-full px-4 py-2 border rounded-lg" />
                </div>
                <div>
                  <label class="block text-sm font-medium mb-2">Category</label>
                  <select id="postCategory" class="w-full px-4 py-2 border rounded-lg">
                    <option value="wellness">Wellness</option>
                    <option value="sustainability">Sustainability</option>
                    <option value="technology">Technology</option>
                    <option value="lifestyle">Lifestyle</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium mb-2">Tags (comma-separated)</label>
                  <input
                    type="text"
                    id="postTags"
                    class="w-full px-4 py-2 border rounded-lg"
                    placeholder="tag1, tag2, tag3"
                  />
                </div>
                <div>
                  <label class="block text-sm font-medium mb-2">Author</label>
                  <input
                    type="text"
                    id="postAuthor"
                    class="w-full px-4 py-2 border rounded-lg"
                    placeholder="Author name"
                  />
                </div>
                <div>
                  <label class="block text-sm font-medium mb-2">Read Time</label>
                  <input
                    type="text"
                    id="postReadTime"
                    class="w-full px-4 py-2 border rounded-lg"
                    placeholder="5 min read"
                  />
                </div>
              </div>
            </div>

            <!-- Preview -->
            <div class="bg-white rounded-xl shadow p-6">
              <h2 class="text-lg font-bold text-primary mb-4">üëÅÔ∏è Preview</h2>
              <div
                id="postPreview"
                class="text-sm border rounded-lg p-4 bg-gray-50 max-h-64 overflow-auto"
              ></div>
            </div>
          </div>
        </div>
      </div>

      <!-- SEO & META TAB -->
      <div id="seo" class="tab-content">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
          <div class="space-y-6">
            <div class="bg-white rounded-xl shadow p-6">
              <h2 class="text-lg font-bold text-primary mb-4">üîç SEO Meta Tags</h2>
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium mb-2">Meta Description</label>
                  <textarea
                    id="metaDescription"
                    rows="3"
                    maxlength="160"
                    class="w-full px-4 py-2 border rounded-lg"
                    placeholder="160 characters recommended"
                  ></textarea>
                  <span class="text-xs text-gray-500" id="metaDescCount">0/160</span>
                </div>
                <div>
                  <label class="block text-sm font-medium mb-2">Meta Keywords</label>
                  <input
                    type="text"
                    id="metaKeywords"
                    class="w-full px-4 py-2 border rounded-lg"
                    placeholder="keyword1, keyword2, keyword3"
                  />
                </div>
                <div>
                  <label class="block text-sm font-medium mb-2">OG Image URL</label>
                  <input
                    type="text"
                    id="ogImage"
                    class="w-full px-4 py-2 border rounded-lg"
                    placeholder="Open Graph image URL"
                  />
                </div>
                <div>
                  <label class="block text-sm font-medium mb-2">Canonical URL</label>
                  <input
                    type="text"
                    id="canonicalUrl"
                    class="w-full px-4 py-2 border rounded-lg"
                    placeholder="https://calmiqs.com/blog/post-slug"
                  />
                </div>
              </div>
            </div>
          </div>

          <div class="space-y-6">
            <div class="bg-white rounded-xl shadow p-6">
              <h2 class="text-lg font-bold text-primary mb-4">üìã JSON Schema</h2>
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium mb-2">Schema Type</label>
                  <select id="schemaType" class="w-full px-4 py-2 border rounded-lg">
                    <option value="Article">Article</option>
                    <option value="BlogPosting">Blog Post</option>
                    <option value="NewsArticle">News Article</option>
                  </select>
                </div>
                <button
                  id="generateSchemaBtn"
                  class="w-full bg-primary text-white px-4 py-2 rounded-lg hover:bg-accent transition"
                >
                  <i class="fas fa-magic"></i>
                  Generate Schema
                </button>
                <div
                  id="schemaPreview"
                  class="bg-gray-50 p-4 rounded-lg text-xs font-mono overflow-auto max-h-64"
                >
                  { Ready to generate }
                </div>
                <button
                  id="copySchemaBtn"
                  class="w-full bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition"
                >
                  <i class="fas fa-copy"></i>
                  Copy Schema
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- IMAGES TAB -->
      <div id="images" class="tab-content">
        <div class="bg-white rounded-xl shadow p-6">
          <h2 class="text-2xl font-bold text-primary mb-6">üñºÔ∏è Image Library</h2>
          <div id="imageLibraryGrid" class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="col-span-full text-center py-8 text-gray-500">Loading images...</div>
          </div>
        </div>
      </div>

      <!-- SETTINGS TAB -->
      <div id="settings" class="tab-content">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
          <div class="bg-white rounded-xl shadow p-6">
            <h2 class="text-lg font-bold text-primary mb-4">üîß Site Configuration</h2>
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium mb-2">Site URL</label>
                <input
                  type="text"
                  id="siteUrl"
                  class="w-full px-4 py-2 border rounded-lg"
                  value="https://calmiqs.pages.dev"
                />
              </div>
              <div>
                <label class="block text-sm font-medium mb-2">Site Title</label>
                <input
                  type="text"
                  id="siteTitle"
                  class="w-full px-4 py-2 border rounded-lg"
                  value="Calmiqs ‚Äì Wellness & Eco Balance"
                />
              </div>
              <div>
                <label class="block text-sm font-medium mb-2">Site Description</label>
                <textarea id="siteDescription" class="w-full px-4 py-2 border rounded-lg" rows="3">
Explore AI-powered wellness tools and eco-friendly insights</textarea
                >
              </div>
              <button
                id="saveSiteSettings"
                class="w-full bg-primary text-white px-4 py-2 rounded-lg hover:bg-accent transition"
              >
                <i class="fas fa-save"></i>
                Save Settings
              </button>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Image Library Modal -->
    <div
      id="imageLibraryModal"
      class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
    >
      <div class="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-auto">
        <div class="flex justify-between items-center p-6 border-b">
          <h3 class="text-xl font-bold text-primary">üìö Image Library</h3>
          <button id="closeLibraryModal" class="text-2xl text-gray-400 hover:text-gray-600">
            √ó
          </button>
        </div>
        <div class="p-6">
          <div id="libraryGridModal" class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="col-span-full text-center py-8 text-gray-500">Loading library...</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Post Library Modal -->
    <div
      id="postLibraryModal"
      class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
    >
      <div class="bg-white rounded-xl max-w-2xl w-full max-h-[90vh] overflow-auto">
        <div class="flex justify-between items-center p-6 border-b">
          <h3 class="text-xl font-bold text-primary">üìö Posts Library</h3>
          <button id="closePostLibraryModal" class="text-2xl text-gray-400 hover:text-gray-600">
            √ó
          </button>
        </div>
        <div class="p-6">
          <div id="postLibraryList">
            <div class="text-center py-8 text-gray-500">Loading posts...</div>
          </div>
        </div>
      </div>
    </div>
    <!-- ============================================ -->
    <!-- HTML VIEW MODAL -->
    <!-- ============================================ -->

    <div
      id="htmlViewModal"
      class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
    >
      <div class="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-auto">
        <div class="flex justify-between items-center p-6 border-b sticky top-0 bg-white">
          <h3 class="text-xl font-bold text-primary">üìù HTML Code View</h3>
          <button id="closeHtmlModal" class="text-2xl text-gray-400 hover:text-gray-600">√ó</button>
        </div>
        <div class="p-6">
          <div style="display: flex; gap: 1rem; margin-bottom: 1rem">
            <button
              id="copyHtmlBtn"
              class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-accent transition"
            >
              <i class="fas fa-copy"></i>
              Copy HTML
            </button>
            <button
              id="pasteHtmlBtn"
              class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition"
            >
              <i class="fas fa-paste"></i>
              Paste HTML
            </button>
          </div>
          <textarea
            id="htmlCodeView"
            style="
              width: 100%;
              height: 500px;
              padding: 1rem;
              border: 2px solid #d1d5db;
              border-radius: 0.5rem;
              font-family: 'Courier New', monospace;
              font-size: 0.875rem;
            "
          ></textarea>
        </div>
      </div>
    </div>
    <script>
      const WORKER_BASE = ""; // Use relative paths for same domain
      const ADMIN_TOKEN = window.CALMIQS_ADMIN_TOKEN;

      let currentPost = null;
      let selectedHeroImage = null;
      // ADD THIS AFTER: let selectedHeroImage = null;

      const contentEditor = document.getElementById("content");

      // Add CSS styles for the editor output
      const style = document.createElement("style");
      style.textContent = `
              #content {
                min-height: 400px;
                padding: 1rem;
                border: 2px solid #d1d5db;
                border-radius: 0.5rem;
                outline: none;
                line-height: 1.6;
                word-wrap: break-word;
                overflow-wrap: break-word;
                white-space: normal;
              }

              #content p {
                margin-bottom: 1rem;
                line-height: 1.6;
              }

              #content h2 {
                font-size: 1.875rem;
                font-weight: bold;
                margin: 1.5rem 0 0.75rem 0;
                color: #1f2937;
              }

              #content h3 {
                font-size: 1.5rem;
                font-weight: bold;
                margin: 1.25rem 0 0.5rem 0;
                color: #1f2937;
              }

              #content h4 {
                font-size: 1.25rem;
                font-weight: bold;
                margin: 1rem 0 0.5rem 0;
                color: #1f2937;
              }

              #content ul,
              #content ol {
                margin-left: 2rem;
                margin-bottom: 1rem;
              }

              #content li {
                margin-bottom: 0.5rem;
              }

              #content blockquote {
                border-left: 4px solid #4FA49A;
                margin-left: 0;
                padding-left: 1rem;
                color: #6b7280;
                font-style: italic;
              }

              #content a {
                color: #5a67d8;
                text-decoration: underline;
              }

              #content a:hover {
                color: #4f46e5;
              }             
            `;
      document.head.appendChild(style);

      // Style editor on focus/blur
      contentEditor.addEventListener("focus", function () {
        this.style.borderColor = "#4FA49A";
        this.style.boxShadow = "0 0 0 3px rgba(79, 164, 154, 0.1)";
        document.getElementById("htmlViewBtn").style.opacity = "1";
      });

      contentEditor.addEventListener("blur", function () {
        this.style.borderColor = "#d1d5db";
        this.style.boxShadow = "none";
      });

      // Update format indicator
      function updateFormatIndicator() {
        const selection = window.getSelection();
        let format = "Plain";

        if (!selection.rangeCount) {
          document.getElementById("formatIndicator").textContent = "Format: " + format;
          return;
        }

        const range = selection.getRangeAt(0);
        let node = range.commonAncestorContainer;

        while (node && node !== contentEditor) {
          const tagName = node.nodeName.toLowerCase();
          if (tagName === "strong" || tagName === "b") format = "Bold";
          if (tagName === "em" || tagName === "i") format = "Italic";
          if (tagName === "h2") format = "Heading 2";
          if (tagName === "h3") format = "Heading 3";
          if (tagName === "h4") format = "Heading 4";
          if (tagName === "ul") format = "Bullet List";
          if (tagName === "ol") format = "Numbered List";
          node = node.parentNode;
        }

        document.getElementById("formatIndicator").textContent = "Format: " + format;
      }

      contentEditor.addEventListener("click", updateFormatIndicator);
      contentEditor.addEventListener("keyup", updateFormatIndicator);
      contentEditor.addEventListener("input", () => updatePreview());

      // Auth fetch helper
      async function authFetch(url, opts = {}) {
        opts.headers = opts.headers || {};
        opts.headers["X-Admin-Token"] = ADMIN_TOKEN;
        return fetch(url, opts);
      }

      // Generate slug from title
      function generateSlug(title) {
        return title
          .toLowerCase()
          .replace(/[^a-z0-9]+/g, "-")
          .replace(/(^-|-$)/g, "");
      }

      // Update preview
      function updatePreview() {
        const title = document.getElementById("postTitle").value || "Untitled";
        const content = document.getElementById("content").innerHTML || "<p>No content</p>";
        const preview = document.getElementById("postPreview");

        // Show actual formatted preview
        preview.innerHTML = `
    <h3 class="font-bold text-primary mb-2">${escapeHtml(title)}</h3>
    <div class="text-sm border-t pt-4" style="max-height: 300px; overflow-y: auto;">
      ${content.substring(0, 500)}
    </div>
  `;

        // Add styling to preview elements
        const previewContent = preview.querySelector("div");
        if (previewContent) {
          previewContent.querySelectorAll("h2, h3, h4").forEach((el) => {
            el.className = "font-bold text-gray-800 my-3";
          });
          previewContent.querySelectorAll("ul, ol").forEach((el) => {
            el.className = "ml-4 my-2";
          });
          previewContent.querySelectorAll("li").forEach((el) => {
            el.className = "my-1";
          });
        }
      }

      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      // Update preview on title change
      document.getElementById("postTitle").addEventListener("input", () => {
        const slug = generateSlug(document.getElementById("postTitle").value);
        document.getElementById("postSlug").value = slug;
        updatePreview();
      });

      // Update preview on content change
      document.getElementById("content").addEventListener("input", updatePreview);
      document.getElementById("content").addEventListener("change", updatePreview);

      // Tab navigation
      document.querySelectorAll(".tab-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          const tabName = btn.dataset.tab;
          document.querySelectorAll(".tab-content").forEach((el) => el.classList.remove("active"));
          document.querySelectorAll(".tab-btn").forEach((el) => {
            el.classList.remove("border-primary", "text-primary");
            el.classList.add("border-transparent", "text-gray-600");
          });
          document.getElementById(tabName).classList.add("active");
          btn.classList.remove("border-transparent", "text-gray-600");
          btn.classList.add("border-primary", "text-primary");

          if (tabName === "images") loadImageLibraryTab();
        });
      });

      // Editor toolbar
      // ============================================
      // FIXED EDITOR TOOLBAR
      // ============================================
      document.querySelectorAll(".editor-toolbar button").forEach((btn) => {
        btn.addEventListener("click", (e) => {
          e.preventDefault();

          const cmd = btn.dataset.cmd;
          const editor = document.getElementById("content");

          console.log("Toolbar command:", cmd);

          editor.focus();

          try {
            if (cmd === "link") {
              const url = prompt("Enter URL:");
              if (url) {
                document.execCommand("createLink", false, url);
              }
            } else if (cmd === "h2") {
              document.execCommand("formatBlock", false, "<h2>");
            } else if (cmd === "h3") {
              document.execCommand("formatBlock", false, "<h3>");
            } else if (cmd === "h4") {
              document.execCommand("formatBlock", false, "<h4>");
            } else if (cmd === "p") {
              document.execCommand("formatBlock", false, "<p>");
            } else if (cmd === "ul") {
              document.execCommand("insertUnorderedList", false, null);
            } else if (cmd === "ol") {
              document.execCommand("insertOrderedList", false, null);
            } else if (cmd === "indent") {
              document.execCommand("indent", false, null);
            } else if (cmd === "outdent") {
              document.execCommand("outdent", false, null);
            } else if (cmd === "bold") {
              document.execCommand("bold", false, null);
            } else if (cmd === "italic") {
              document.execCommand("italic", false, null);
            } else if (cmd === "underline") {
              document.execCommand("underline", false, null);
            }

            updatePreview();
            updateFormatIndicator();
          } catch (error) {
            console.error("Editor command error:", error);
          }

          editor.focus();
        });
      });
      // ========================================
      // STEP 4: ADD HTML VIEW TOGGLE CODE
      // ========================================

      // ADD THIS NEW SECTION (after the toolbar code above):

      const htmlViewBtn = document.getElementById("htmlViewBtn");
      const htmlViewModal = document.getElementById("htmlViewModal");
      const closeHtmlModal = document.getElementById("closeHtmlModal");
      const htmlCodeView = document.getElementById("htmlCodeView");
      const copyHtmlBtn = document.getElementById("copyHtmlBtn");
      const pasteHtmlBtn = document.getElementById("pasteHtmlBtn");

      if (htmlViewBtn) {
        htmlViewBtn.addEventListener("click", (e) => {
          e.preventDefault();
          const editor = document.getElementById("content");
          htmlCodeView.value = editor.innerHTML;
          htmlViewModal.classList.remove("hidden");
        });
      }

      if (closeHtmlModal) {
        closeHtmlModal.addEventListener("click", () => {
          htmlViewModal.classList.add("hidden");
        });
      }

      if (copyHtmlBtn) {
        copyHtmlBtn.addEventListener("click", () => {
          htmlCodeView.select();
          document.execCommand("copy");
          alert("‚úÖ HTML copied to clipboard");
        });
      }

      if (pasteHtmlBtn) {
        pasteHtmlBtn.addEventListener("click", async () => {
          try {
            const html = htmlCodeView.value;
            const editor = document.getElementById("content");
            editor.innerHTML = html;
            htmlViewModal.classList.add("hidden");
            updatePreview();
            alert("‚úÖ HTML pasted into editor");
          } catch (err) {
            alert("‚ùå Error: " + err.message);
          }
        });
      }

      // Close modal on background click
      htmlViewModal.addEventListener("click", (e) => {
        if (e.target === htmlViewModal) {
          htmlViewModal.classList.add("hidden");
        }
      });

      // Title input
      document.getElementById("postTitle").addEventListener("input", () => {
        const slug = generateSlug(document.getElementById("postTitle").value);
        document.getElementById("postSlug").value = slug;
        updatePreview();
      });

      // Content input
      document.getElementById("content").addEventListener("input", updatePreview);

      // Meta description counter
      document.getElementById("metaDescription").addEventListener("input", (e) => {
        document.getElementById("metaDescCount").textContent = `${e.target.value.length}/160`;
      });

      // New Post
      document.getElementById("newPostBtn").addEventListener("click", () => {
        document.getElementById("postTitle").value = "";
        document.getElementById("postSlug").value = "";
        document.getElementById("postExcerpt").value = "";
        document.getElementById("postDate").value = new Date().toISOString().split("T")[0];
        document.getElementById("content").innerHTML = "";
        document.getElementById("postCategory").value = "wellness";
        document.getElementById("postTags").value = "";
        document.getElementById("postAuthor").value = "Calmiqs Team";
        document.getElementById("postReadTime").value = "";
        document.getElementById("metaDescription").value = "";
        document.getElementById("metaKeywords").value = "";
        document.getElementById("canonicalUrl").value = "";
        document.getElementById("heroImageFile").value = "";
        document.getElementById("heroAlt").value = "";
        document.getElementById("heroPreview").innerHTML = "";
        selectedHeroImage = null;
        currentPost = null;
        updatePreview();
      });

      // Save Post
      document.getElementById("savePostBtn").addEventListener("click", async () => {
        const title = document.getElementById("postTitle").value.trim();
        if (!title) return alert("Enter post title");

        const postData = {
          title,
          slug: generateSlug(title),
          excerpt: document.getElementById("postExcerpt").value,
          date: document.getElementById("postDate").value,
          category: document.getElementById("postCategory").value,
          tags: document
            .getElementById("postTags")
            .value.split(",")
            .map((t) => t.trim())
            .filter((t) => t),
          author: document.getElementById("postAuthor").value,
          readTime: document.getElementById("postReadTime").value,
          content: document.getElementById("content").innerHTML,
          image: selectedHeroImage || "",
          imageAlt: document.getElementById("heroAlt").value,
          metaDescription: document.getElementById("metaDescription").value,
          metaKeywords: document.getElementById("metaKeywords").value,
          ogImage: document.getElementById("ogImage").value,
          canonicalUrl: document.getElementById("canonicalUrl").value,
        };

        try {
          const res = await authFetch(`/api/posts`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(postData),
          });
          const result = await res.json();
          if (res.ok) {
            alert("‚úÖ Post saved successfully!");
          } else {
            alert("‚ùå " + (result.error || "Save failed"));
          }
        } catch (err) {
          console.error(err);
          alert("‚ùå Save failed: " + err.message);
        }
      });

      // Load Post
      document.getElementById("loadPostBtn").addEventListener("click", () => {
        const modal = document.getElementById("postLibraryModal");
        modal.classList.remove("hidden");
        loadPostLibrary();
      });

      async function loadPostLibrary() {
        try {
          const res = await authFetch(`/api/posts`);
          const data = await res.json();
          const list = document.getElementById("postLibraryList");
          list.innerHTML = "";

          let postsArray = [];
          if (data.success && data.posts) {
            postsArray = data.posts;
          } else if (Array.isArray(data)) {
            postsArray = data;
          } else if (typeof data === "object") {
            postsArray = Object.entries(data).map(([slug, post]) => ({
              ...post,
              slug: slug,
            }));
          }

          if (postsArray.length === 0) {
            list.innerHTML = "<p class='text-center text-gray-500 py-8'>No posts yet</p>";
            return;
          }

          postsArray.forEach((post) => {
            const el = document.createElement("div");
            el.className = "p-4 border-b hover:bg-gray-50 cursor-pointer transition";
            el.innerHTML = `
                          <div class="font-semibold text-primary">${post.title}</div>
                          <div class="text-xs text-gray-500">${post.slug} ‚Ä¢ ${new Date(
              post.date
            ).toLocaleDateString()}</div>
                        `;
            el.addEventListener("click", () => {
              loadPostToEditor(post);
              document.getElementById("postLibraryModal").classList.add("hidden");
            });
            list.appendChild(el);
          });
        } catch (err) {
          console.error(err);
          document.getElementById("postLibraryList").innerHTML =
            "<p class='text-center text-red-600 py-8'>Failed to load posts</p>";
        }
      }

      function loadPostToEditor(post) {
        document.getElementById("postTitle").value = post.title;
        document.getElementById("postExcerpt").value = post.excerpt || "";
        document.getElementById("postDate").value = post.date;
        document.getElementById("content").innerHTML = post.content || "";
        document.getElementById("postCategory").value = post.category || "wellness";
        document.getElementById("postTags").value = (post.tags || []).join(", ");
        document.getElementById("postAuthor").value = post.author || "";
        document.getElementById("postReadTime").value = post.readTime || "";
        document.getElementById("metaDescription").value = post.metaDescription || "";
        document.getElementById("metaKeywords").value = post.metaKeywords || "";
        document.getElementById("canonicalUrl").value = post.canonicalUrl || "";
        document.getElementById("heroAlt").value = post.imageAlt || "";
        document.getElementById("postSlug").value = post.slug;
        selectedHeroImage = post.image;

        if (post.image) {
          document.getElementById("heroPreview").innerHTML = `<img src="${post.image}" alt="${
            post.imageAlt || "Hero"
          }" class="max-w-full rounded-lg shadow-md" />`;
        }

        currentPost = post;
        updatePreview();
      }

      // Delete Post
      document.getElementById("deletePostBtn").addEventListener("click", async () => {
        const slug = document.getElementById("postSlug").value;
        if (!slug) return alert("No post selected");
        if (!confirm("Delete this post? This cannot be undone.")) return;

        try {
          const res = await authFetch(`/api/posts/${slug}`, { method: "DELETE" });
          if (res.ok) {
            alert("‚úÖ Post deleted");
            document.getElementById("newPostBtn").click();
          } else {
            alert("‚ùå Delete failed");
          }
        } catch (err) {
          alert("‚ùå Error: " + err.message);
        }
      });

      // Upload Hero Image
      document.getElementById("uploadHeroBtn").addEventListener("click", async () => {
        const file = document.getElementById("heroImageFile").files[0];
        if (!file) return alert("Choose an image");

        const form = new FormData();
        form.append("file", file);
        form.append("alt", document.getElementById("heroAlt").value || file.name);
        form.append("title", document.getElementById("postTitle").value || file.name);

        try {
          document.getElementById("uploadHeroBtn").disabled = true;
          document.getElementById("uploadHeroBtn").innerHTML =
            '<i class="fas fa-spinner fa-spin"></i> Uploading...';

          console.log("Uploading to /upload...");
          const res = await authFetch(`/upload`, {
            method: "POST",
            body: form,
          });

          console.log("Upload response status:", res.status);
          const data = await res.json();
          console.log("Upload response data:", data);

          if (res.ok && data.success) {
            const imageUrl = data.url;
            selectedHeroImage = imageUrl;

            document.getElementById("heroPreview").innerHTML = `<img src="${imageUrl}" alt="${
              data.metadata?.alt || "Hero image"
            }" class="max-w-full rounded-lg shadow-md"
                                onerror="this.onerror=null; this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22400%22 height=%22300%22><rect width=%22400%22 height=%22300%22 fill=%22%23f0f0f0%22/><text x=%2250%25%22 y=%2250%25%22 fill=%22%23999%22 text-anchor=%22middle%22 dy=%22.3em%22>Image uploaded</text></svg>';" />`;

            alert("‚úÖ Hero image uploaded successfully!");
          } else {
            throw new Error(data.error || `HTTP ${res.status}: ${res.statusText}`);
          }
        } catch (err) {
          console.error("Upload error:", err);
          alert(
            "‚ùå Upload failed: " +
              err.message +
              "\n\nTry checking:\n1. Is the worker running?\n2. Is the upload endpoint configured?\n3. Check browser console for details"
          );
        } finally {
          document.getElementById("uploadHeroBtn").disabled = false;
          document.getElementById("uploadHeroBtn").innerHTML =
            '<i class="fas fa-cloud-upload-alt"></i> Upload';
        }
      });

      // Select Hero from Library
      document.getElementById("selectHeroBtn").addEventListener("click", () => {
        const modal = document.getElementById("imageLibraryModal");
        modal.classList.remove("hidden");
        loadImageLibraryForHero();
      });

      async function loadImageLibraryForHero() {
        try {
          console.log("Loading image library for hero...");

          const res = await authFetch(`/list`);

          if (!res.ok) {
            const errorText = await res.text();
            console.error(`HTTP ${res.status}:`, errorText);
            throw new Error(`HTTP ${res.status}: Failed to load images`);
          }

          const data = await res.json();
          console.log("Library data:", data);

          const grid = document.getElementById("libraryGridModal");
          grid.innerHTML = "";

          if (!data.images || data.images.length === 0) {
            grid.innerHTML =
              "<div class='col-span-full text-center text-gray-500 py-8'>No images in library. Upload some images first!</div>";
            return;
          }

          data.images.forEach((img) => {
            const thumb = document.createElement("div");
            thumb.className =
              "relative group cursor-pointer bg-white rounded-lg overflow-hidden shadow hover:shadow-lg transition";

            // FIXED: Use correct URL format
            const imageUrl = `https://calmiqs-images-worker.techaipet.workers.dev/files/${encodeURIComponent(
              img.r2Key
            )}`;
            console.log("Loading hero image:", imageUrl);

            // Create container with fixed height
            const imgContainer = document.createElement("div");
            imgContainer.style.cssText =
              "width: 100%; height: 128px; background: #f3f4f6; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden;";

            const imgEl = document.createElement("img");
            imgEl.src = imageUrl;
            imgEl.alt = img.alt || "";
            imgEl.style.cssText = "width: 100%; height: 100%; object-fit: cover;";
            imgEl.className = "hover:opacity-75 transition";

            // Handle load errors
            imgEl.onerror = function () {
              console.error("Image failed to load:", imageUrl);
              imgContainer.innerHTML =
                '<div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: #f3f4f6; color: #999; font-size: 0.75rem;">Image load error</div>';
            };

            imgContainer.appendChild(imgEl);

            const overlay = document.createElement("div");
            overlay.style.cssText =
              "position: absolute; inset: 0; background: rgba(0,0,0,0); transition: background 0.2s;";
            overlay.className = "group-hover:bg-black/30 flex items-center justify-center";

            const selectText = document.createElement("span");
            selectText.textContent = "Select";
            selectText.style.cssText =
              "color: white; opacity: 0; transition: opacity 0.2s; font-weight: 500;";
            selectText.className = "group-hover:opacity-100";

            overlay.appendChild(selectText);
            imgContainer.appendChild(overlay);

            const infoDiv = document.createElement("div");
            infoDiv.style.cssText = "padding: 0.5rem; text-align: center; background: white;";
            infoDiv.innerHTML = `
        <p style="font-size: 0.75rem; font-weight: 500; color: #374151; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin: 0;">${
          img.title || img.filename || "Image"
        }</p>
        <p style="font-size: 0.75rem; color: #6b7280; margin: 0.25rem 0 0 0;">${
          img.alt || "No description"
        }</p>
      `;

            thumb.appendChild(imgContainer);
            thumb.appendChild(infoDiv);

            thumb.addEventListener("click", () => {
              selectedHeroImage = imageUrl;
              document.getElementById("heroPreview").innerHTML = `<img src="${imageUrl}" 
          alt="${img.alt || "Hero"}" 
          style="max-width: 100%; border-radius: 0.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1);" 
          onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22400%22 height=%22300%22><rect fill=%22%23f0f0f0%22 width=%22400%22 height=%22300%22/><text x=%2250%25%22 y=%2250%25%22 fill=%22%23999%22 text-anchor=%22middle%22 dy=%22.3em%22>Image</text></svg>';" />`;
              document.getElementById("heroAlt").value = img.alt || "";
              document.getElementById("imageLibraryModal").classList.add("hidden");
              alert("‚úÖ Hero image selected");
            });

            grid.appendChild(thumb);
          });
        } catch (err) {
          console.error("Library load error:", err);
          document.getElementById(
            "libraryGridModal"
          ).innerHTML = `<div class='col-span-full text-center text-red-600 py-8'>
      Failed to load library: ${err.message}
    </div>`;
        }
      }
      // Insert Image Button (from library)
      document.getElementById("insertImageBtn").addEventListener("click", () => {
        const modal = document.getElementById("imageLibraryModal");
        modal.classList.remove("hidden");
        loadImageLibraryForInline();
      });

      // Select Inline Image from Library
      document.getElementById("selectInlineBtn").addEventListener("click", () => {
        const modal = document.getElementById("imageLibraryModal");
        modal.classList.remove("hidden");
        loadImageLibraryForInline();
      });

      // Upload Inline Image
      // ============================================
      // FIXED INLINE IMAGE INSERTION
      // ============================================

      document.getElementById("uploadInlineBtn").addEventListener("click", async () => {
        const file = document.getElementById("inlineImageFile").files[0];
        if (!file) return alert("Choose an image");

        const form = new FormData();
        form.append("file", file);
        form.append("alt", file.name);
        form.append("title", file.name);

        try {
          const btn = document.getElementById("uploadInlineBtn");
          btn.disabled = true;
          btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';

          const res = await authFetch(`/upload`, {
            method: "POST",
            body: form,
          });

          const data = await res.json();
          console.log("Upload response:", data);

          if (res.ok && data.success) {
            const imageUrl = data.url;
            const editor = document.getElementById("content");

            // CRITICAL FIX: Save current selection before focusing
            const selection = window.getSelection();
            let savedSelection = null;

            if (selection.rangeCount > 0) {
              savedSelection = selection.getRangeAt(0);
            }

            editor.focus();

            // Create image wrapper for better control
            const imgWrapper = document.createElement("div");
            imgWrapper.className = "inline-image-wrapper";
            imgWrapper.style.cssText = "position: relative; display: inline-block; margin: 1rem 0;";

            const imgElement = document.createElement("img");
            imgElement.src = imageUrl;
            imgElement.alt = data.metadata?.alt || file.name;
            imgElement.className = "inline-img";
            imgElement.setAttribute("data-src", imageUrl);
            imgElement.style.cssText = `
        max-width: 100%;
        height: auto;
        display: block;
        border-radius: 0.5rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        cursor: pointer;
      `;
            imgElement.contentEditable = "false";

            // Image click handler for selection and formatting
            imgElement.addEventListener("click", function (e) {
              e.preventDefault();
              e.stopPropagation();

              // Show image toolbar
              showImageToolbar(this);
            });

            imgWrapper.appendChild(imgElement);

            // Insert at saved cursor position
            if (savedSelection && savedSelection.commonAncestorContainer.parentNode === editor) {
              try {
                savedSelection.insertNode(imgWrapper);
                // Move cursor after image
                savedSelection.setStartAfter(imgWrapper);
                savedSelection.collapse(true);
                const sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(savedSelection);
              } catch (e) {
                console.error("Error inserting at cursor:", e);
                editor.appendChild(imgWrapper);
              }
            } else {
              editor.appendChild(imgWrapper);
            }

            // Add paragraph after image for continued typing
            const p = document.createElement("p");
            p.innerHTML = "<br>";
            imgWrapper.parentNode.insertBefore(p, imgWrapper.nextSibling);
            p.focus();

            document.getElementById("inlineImageFile").value = "";
            updatePreview();
            alert("‚úÖ Image inserted at cursor");
          } else {
            throw new Error(data.error || "Upload failed");
          }
        } catch (err) {
          console.error("Error:", err);
          alert("‚ùå " + err.message);
        } finally {
          const btn = document.getElementById("uploadInlineBtn");
          btn.disabled = false;
          btn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Upload & Insert';
        }
      });
      function showImageToolbar(imgElement) {
        // Remove any existing toolbar
        const existingToolbar = document.getElementById("imageFormattingToolbar");
        if (existingToolbar) existingToolbar.remove();

        // Create toolbar
        const toolbar = document.createElement("div");
        toolbar.id = "imageFormattingToolbar";
        toolbar.style.cssText = `
    position: absolute;
    top: -50px;
    left: 0;
    background: #333;
    color: white;
    padding: 0.5rem;
    border-radius: 0.375rem;
    display: flex;
    gap: 0.5rem;
    z-index: 1000;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  `;

        const wrapper = imgElement.parentElement;
        wrapper.style.position = "relative";

        // WIDTH CONTROL
        const widthLabel = document.createElement("span");
        widthLabel.textContent = "Width:";
        widthLabel.style.color = "#ccc";
        widthLabel.style.fontSize = "0.75rem";

        const widthInput = document.createElement("input");
        widthInput.type = "number";
        widthInput.value = imgElement.width || 100;
        widthInput.min = 50;
        widthInput.max = 800;
        widthInput.style.cssText =
          "width: 50px; padding: 0.25rem; border-radius: 0.25rem; border: none;";

        widthInput.addEventListener("change", () => {
          imgElement.style.width = widthInput.value + "px";
          imgElement.style.height = "auto";
          updatePreview();
        });

        // ALIGNMENT CONTROL
        const alignLabel = document.createElement("span");
        alignLabel.textContent = "Align:";
        alignLabel.style.color = "#ccc";
        alignLabel.style.fontSize = "0.75rem";

        const alignSelect = document.createElement("select");
        alignSelect.style.cssText = "padding: 0.25rem; border-radius: 0.25rem; border: none;";
        alignSelect.innerHTML = `
    <option value="block">Block</option>
    <option value="left">Left</option>
    <option value="right">Right</option>
    <option value="center">Center</option>
  `;

        alignSelect.addEventListener("change", () => {
          wrapper.style.display = alignSelect.value === "block" ? "block" : "inline";
          if (alignSelect.value === "left") {
            imgElement.style.float = "left";
            imgElement.style.marginRight = "1rem";
          } else if (alignSelect.value === "right") {
            imgElement.style.float = "right";
            imgElement.style.marginLeft = "1rem";
          } else if (alignSelect.value === "center") {
            imgElement.style.float = "none";
            wrapper.style.textAlign = "center";
          } else {
            imgElement.style.float = "none";
            wrapper.style.textAlign = "left";
          }
          updatePreview();
        });

        // DELETE BUTTON
        const deleteBtn = document.createElement("button");
        deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
        deleteBtn.style.cssText = `
    background: #dc2626;
    color: white;
    border: none;
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    cursor: pointer;
    font-size: 0.75rem;
  `;

        deleteBtn.addEventListener("click", () => {
          wrapper.remove();
          updatePreview();
        });

        // CLOSE BUTTON
        const closeBtn = document.createElement("button");
        closeBtn.innerHTML = "‚úï";
        closeBtn.style.cssText = `
    background: #6b7280;
    color: white;
    border: none;
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    cursor: pointer;
    font-size: 0.75rem;
  `;

        closeBtn.addEventListener("click", () => {
          toolbar.remove();
        });

        toolbar.appendChild(widthLabel);
        toolbar.appendChild(widthInput);
        toolbar.appendChild(alignLabel);
        toolbar.appendChild(alignSelect);
        toolbar.appendChild(deleteBtn);
        toolbar.appendChild(closeBtn);

        wrapper.appendChild(toolbar);
      }

      // Close image toolbar when clicking outside
      document.addEventListener("click", function (e) {
        if (
          !e.target.closest(".inline-image-wrapper") &&
          !e.target.closest("#imageFormattingToolbar")
        ) {
          const toolbar = document.getElementById("imageFormattingToolbar");
          if (toolbar) toolbar.remove();
        }
      });

      async function loadImageLibraryForInline() {
        try {
          console.log("Loading image library for inline...");
          const res = await authFetch(`/list`);

          if (!res.ok) {
            const errorText = await res.text();
            console.error(`HTTP ${res.status}:`, errorText);
            throw new Error(`HTTP ${res.status}: Failed to load images`);
          }

          const data = await res.json();
          console.log("Library data:", data);

          const grid = document.getElementById("libraryGridModal");
          grid.innerHTML = "";

          if (!data.images || data.images.length === 0) {
            grid.innerHTML =
              "<div class='col-span-full text-center text-gray-500 py-8'>No images in library. Upload some images first!</div>";
            return;
          }

          data.images.forEach((img) => {
            const thumb = document.createElement("div");
            thumb.className = "relative group cursor-pointer bg-white rounded-lg overflow-hidden";

            // Use correct R2 URL format
            const imageUrl = `https://calmiqs-images-worker.techaipet.workers.dev/files/${encodeURIComponent(
              img.r2Key
            )}`;
            console.log("Image URL:", imageUrl);

            thumb.innerHTML = `
                    <div style="width: 100%; height: 128px; background: #f3f4f6; display: flex; align-items: center; justify-content: center; position: relative;">
                      <img src="${imageUrl}"
                           alt="${img.alt || ""}"
                           style="max-width: 100%; max-height: 100%; object-fit: cover; width: 100%; height: 100%;"
                           class="hover:opacity-75 transition" />
                      <div style="position: absolute; inset: 0; background: rgba(0,0,0,0); transition: background 0.2s;" class="group-hover:bg-black/30 flex items-center justify-center">
                        <span style="color: white; opacity: 0; transition: opacity 0.2s; font-weight: 500;" class="group-hover:opacity-100">Select</span>
                      </div>
                    </div>
                    <div style="padding: 0.5rem; text-align: center;">
                      <p style="font-size: 0.75rem; font-weight: 500; color: #374151; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${
                        img.title || img.filename || "Image"
                      }</p>
                      <p style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">${
                        img.alt || "No description"
                      }</p>
                    </div>
                  `;

            thumb.addEventListener("click", () => {
              const editor = document.getElementById("content");

              // Save current selection
              const selection = window.getSelection();
              let savedSelection = null;

              if (selection.rangeCount > 0) {
                savedSelection = selection.getRangeAt(0);
              }

              editor.focus();

              // Create wrapper
              const imgWrapper = document.createElement("div");
              imgWrapper.className = "inline-image-wrapper";
              imgWrapper.style.cssText =
                "position: relative; display: inline-block; margin: 1rem 0;";

              const imgElement = document.createElement("img");
              imgElement.src = imageUrl;
              imgElement.alt = img.alt || "";
              imgElement.className = "inline-img";
              imgElement.style.cssText = `
    max-width: 100%;
    height: auto;
    display: block;
    border-radius: 0.5rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    cursor: pointer;
  `;
              imgElement.contentEditable = "false";

              imgElement.addEventListener("click", function (e) {
                e.preventDefault();
                showImageToolbar(this);
              });

              imgWrapper.appendChild(imgElement);

              // Insert at saved position
              if (savedSelection && savedSelection.commonAncestorContainer.parentNode === editor) {
                try {
                  savedSelection.insertNode(imgWrapper);
                  savedSelection.setStartAfter(imgWrapper);
                  savedSelection.collapse(true);
                  const sel = window.getSelection();
                  sel.removeAllRanges();
                  sel.addRange(savedSelection);
                } catch (e) {
                  editor.appendChild(imgWrapper);
                }
              } else {
                editor.appendChild(imgWrapper);
              }

              const p = document.createElement("p");
              p.innerHTML = "<br>";
              imgWrapper.parentNode.insertBefore(p, imgWrapper.nextSibling);
              p.focus();

              document.getElementById("imageLibraryModal").classList.add("hidden");
              updatePreview();
            });

            grid.appendChild(thumb);
          });
        } catch (err) {
          console.error("Library load error:", err);
          document.getElementById(
            "libraryGridModal"
          ).innerHTML = `<div class='col-span-full text-center text-red-600 py-8'>
                  Failed to load library
                  <br><span class="text-xs">${err.message}</span>
                  <br><span class="text-xs text-gray-500">Possible causes:<br>
                  1. Images not uploaded yet<br>
                  2. Invalid admin token<br>
                  3. KV namespace not configured<br>
                  4. R2 bucket not accessible
                  </span>
                </div>`;
        }
      }

      // Load Image Library Tab
      async function loadImageLibraryTab() {
        try {
          console.log("Loading images tab...");
          const res = await authFetch(`/list`);

          if (!res.ok) {
            const errorText = await res.text();
            console.error(`HTTP ${res.status}:`, errorText);
            throw new Error(`HTTP ${res.status}: Failed to load images`);
          }

          const data = await res.json();
          console.log("Images tab data:", data);

          const grid = document.getElementById("imageLibraryGrid");
          grid.innerHTML = "";

          if (!data.images || data.images.length === 0) {
            grid.innerHTML =
              "<div class='col-span-full text-center text-gray-500 py-8'>No images uploaded yet. Upload images from the Editor tab!</div>";
            return;
          }

          data.images.forEach((img) => {
            const card = document.createElement("div");
            card.className =
              "bg-white rounded-lg overflow-hidden shadow hover:shadow-lg transition";

            const imageUrl = `https://calmiqs-images-worker.techaipet.workers.dev/files/${encodeURIComponent(
              img.r2Key
            )}`;

            card.innerHTML = `
                    <div style="width: 100%; height: 160px; background: #f3f4f6; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                      <img src="${imageUrl}"
                           alt="${img.alt || ""}"
                           style="max-width: 100%; max-height: 100%; object-fit: cover; width: 100%; height: 100%;" />
                    </div>
                    <div style="padding: 1rem;">
                      <p style="font-size: 0.875rem; font-weight: 500; color: #374151; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${
                        img.title || img.filename || "Image"
                      }</p>
                      <p style="font-size: 0.75rem; color: #6b7280; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 0.25rem;">${
                        img.alt || "No description"
                      }</p>
                      <p style="font-size: 0.75rem; color: #9ca3af; margin-top: 0.5rem;">${new Date(
                        img.uploadedAt || img.createdAt
                      ).toLocaleDateString()}</p>
                    </div>
                  `;
            grid.appendChild(card);
          });
        } catch (err) {
          console.error("Images tab error:", err);
          document.getElementById(
            "imageLibraryGrid"
          ).innerHTML = `<div class='col-span-full text-center text-red-600 py-8'>
                  Failed to load images
                  <br><span class="text-xs">${err.message}</span>
                </div>`;
        }
      }

      // Generate Schema
      document.getElementById("generateSchemaBtn").addEventListener("click", () => {
        const schemaType = document.getElementById("schemaType").value;
        const title = document.getElementById("postTitle").value || "Untitled";
        const excerpt = document.getElementById("postExcerpt").value || "";
        const author = document.getElementById("postAuthor").value || "Calmiqs Team";
        const date = document.getElementById("postDate").value || new Date().toISOString();

        const schema = {
          "@context": "https://schema.org",
          "@type": schemaType,
          headline: title,
          description: excerpt,
          author: { "@type": "Person", name: author },
          datePublished: date,
          image:
            document.getElementById("ogImage").value ||
            selectedHeroImage ||
            "https://calmiqs.pages.dev/assets/logo.svg",
          publisher: {
            "@type": "Organization",
            name: "Calmiqs",
            logo: "https://calmiqs.pages.dev/assets/logo.svg",
          },
        };

        document.getElementById("schemaPreview").textContent = JSON.stringify(schema, null, 2);
      });

      // Copy Schema
      document.getElementById("copySchemaBtn").addEventListener("click", () => {
        const schema = document.getElementById("schemaPreview").textContent;
        navigator.clipboard
          .writeText(schema)
          .then(() => {
            alert("‚úÖ Schema copied to clipboard");
          })
          .catch(() => {
            alert("Failed to copy");
          });
      });

      // Save Site Settings
      document.getElementById("saveSiteSettings").addEventListener("click", () => {
        const settings = {
          siteUrl: document.getElementById("siteUrl").value,
          siteTitle: document.getElementById("siteTitle").value,
          siteDescription: document.getElementById("siteDescription").value,
        };
        localStorage.setItem("calmiqsSiteSettings", JSON.stringify(settings));
        alert("‚úÖ Settings saved");
      });

      // Close modals
      document.getElementById("closeLibraryModal").addEventListener("click", () => {
        document.getElementById("imageLibraryModal").classList.add("hidden");
      });

      document.getElementById("closePostLibraryModal").addEventListener("click", () => {
        document.getElementById("postLibraryModal").classList.add("hidden");
      });

      // Close modals on backdrop click
      document.getElementById("imageLibraryModal").addEventListener("click", (e) => {
        if (e.target.id === "imageLibraryModal") {
          e.target.classList.add("hidden");
        }
      });

      document.getElementById("postLibraryModal").addEventListener("click", (e) => {
        if (e.target.id === "postLibraryModal") {
          e.target.classList.add("hidden");
        }
      });

      // Logout
      document.getElementById("logoutBtn").addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();
        localStorage.removeItem("calmiqsAuth");
        sessionStorage.removeItem("calmiqsAuth");
        localStorage.removeItem("isAdmin");
        sessionStorage.removeItem("isAdmin");
        window.location.href = "/";
      });

      // Initialize
      document.getElementById("postDate").valueAsDate = new Date();
      const settings = JSON.parse(localStorage.getItem("calmiqsSiteSettings") || "{}");
      if (settings.siteUrl) document.getElementById("siteUrl").value = settings.siteUrl;
      if (settings.siteTitle) document.getElementById("siteTitle").value = settings.siteTitle;
      if (settings.siteDescription)
        document.getElementById("siteDescription").value = settings.siteDescription;
      updatePreview();
    </script>
  </body>
</html>
