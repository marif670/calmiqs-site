<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Calmiqs Blog Post</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#4FA49A",
              accent: "#FFD580",
              tech: "#5A67D8",
            },
            fontFamily: { sans: ["Poppins", "sans-serif"] },
          },
        },
      };
    </script>

    <link rel="stylesheet" href="/assets/css/style.css?v=12" />
  </head>

  <body class="font-sans bg-[#F9FAFB] text-gray-800">
    <div id="navbar-container"></div>

    <main class="max-w-4xl mx-auto py-16 px-6">
      <div id="postContainer" class="text-center">
        <p class="text-gray-500">Loading post...</p>
      </div>
      <div id="postNav" class="flex justify-between mt-12"></div>
    </main>

    <footer class="bg-gray-100 py-8 mt-16 text-center text-gray-600">
      <p>© 2025 Calmiqs – Wellness Meets Sustainability</p>
    </footer>

    <div id="footer-container"></div>

    <script>
      async function loadFragment(url, selector) {
        try {
          const res = await fetch(url);
          if (!res.ok) throw new Error(`Failed to load ${url}`);
          document.querySelector(selector).innerHTML = await res.text();
        } catch (err) {
          console.error(`Failed to load ${url}:`, err);
        }
      }

      (async () => {
        const params = new URLSearchParams(window.location.search);
        const postSlug = params.get("post");

        if (!postSlug) {
          document.getElementById("postContainer").innerHTML =
            "<p class='text-red-600'>No post specified</p>";
          return;
        }

        try {
          console.log("Loading post:", postSlug);

          // Fetch all posts - NO authentication required
          const res = await fetch("/api/posts");

          if (!res.ok) {
            throw new Error(`Server responded with status ${res.status}`);
          }

          const data = await res.json();

          if (!data.success) {
            throw new Error(data.error || "Failed to load posts");
          }

          const posts = data.posts || [];
          console.log("Posts available:", posts.length);

          const post = posts.find((p) => p.slug === postSlug);

          if (!post) {
            console.error(
              "Post not found. Available slugs:",
              posts.map((p) => p.slug)
            );
            document.getElementById(
              "postContainer"
            ).innerHTML = `<p class='text-red-600'>Post not found: ${postSlug}</p>`;
            return;
          }

          console.log("Post loaded successfully:", post.title);

          // Update page title
          document.title = `${post.title} - Calmiqs`;

          // Populate post content
          document.getElementById("postContainer").innerHTML = `
            <article class="bg-white rounded-2xl shadow-lg p-8 md:p-12">
              <nav class="mb-6 text-sm text-gray-600" aria-label="Breadcrumb">
                <a href="/" class="text-primary hover:underline">Home</a> / 
                <a href="/blog.html" class="text-primary hover:underline">Blog</a> / 
                <span class="text-gray-800">${post.title}</span>
              </nav>

              <div class="flex gap-4 text-sm text-gray-500 mb-4 flex-wrap">
                <span>${new Date(post.date).toLocaleDateString()}</span>
                <span>•</span>
                <span>${post.author || "Calmiqs Team"}</span>
                <span>•</span>
                <span>${post.readTime || "5 min read"}</span>
                <span>•</span>
                <span class="px-2 py-1 bg-primary/10 text-primary rounded">${
                  post.category || "Blog"
                }</span>
              </div>

              <h1 class="text-4xl md:text-5xl font-bold text-primary mb-4">${post.title}</h1>

              <p class="text-lg text-gray-600 mb-8">${post.excerpt || ""}</p>

              ${
                post.image
                  ? `
                <figure class="mb-8">
                  <img src="${post.image}" alt="${
                      post.imageAlt || post.title
                    }" class="w-full h-96 object-cover rounded-2xl shadow-lg" />
                  <figcaption class="text-sm text-gray-600 mt-2 text-center italic">${
                    post.imageAlt || ""
                  }</figcaption>
                </figure>
              `
                  : ""
              }

              <div class="prose prose-lg max-w-none mb-8">
                ${post.content}
              </div>

              ${
                post.tags && post.tags.length > 0
                  ? `
                <div class="mb-8 flex flex-wrap gap-2">
                  ${post.tags
                    .map(
                      (tag) =>
                        `<a href="/blog.html?tags=${tag}" class="px-3 py-1 bg-primary/10 text-primary rounded-full text-sm hover:bg-primary hover:text-white transition">#${tag}</a>`
                    )
                    .join("")}
                </div>
              `
                  : ""
              }

              <div class="border-t border-gray-200 pt-6 mt-8">
                <h3 class="font-semibold mb-2">About the Author</h3>
                <p class="text-gray-600">${
                  post.author || "Calmiqs Team"
                } - Professional wellness and sustainability advocate.</p>
              </div>
            </article>
          `;

          // Generate navigation to prev/next posts
          const currentIndex = posts.findIndex((p) => p.slug === postSlug);
          const prevPost = currentIndex > 0 ? posts[currentIndex - 1] : null;
          const nextPost = currentIndex < posts.length - 1 ? posts[currentIndex + 1] : null;

          let navHTML = "";
          if (prevPost) {
            navHTML += `<a href="post-template.html?post=${prevPost.slug}" class="flex-1 p-4 bg-white rounded-lg shadow hover:shadow-lg transition">
              <div class="text-sm text-gray-600">← Previous</div>
              <div class="font-semibold text-primary">${prevPost.title}</div>
            </a>`;
          }
          if (nextPost) {
            navHTML += `<a href="post-template.html?post=${nextPost.slug}" class="flex-1 p-4 bg-white rounded-lg shadow hover:shadow-lg transition text-right">
              <div class="text-sm text-gray-600">Next →</div>
              <div class="font-semibold text-primary">${nextPost.title}</div>
            </a>`;
          }

          if (navHTML) {
            document.getElementById("postNav").innerHTML = navHTML;
          }
        } catch (err) {
          console.error("Error loading post:", err);
          document.getElementById(
            "postContainer"
          ).innerHTML = `<p class='text-red-600'>Error loading post: ${err.message}</p>`;
        }

        // Load header and footer
        loadFragment("/assets/components/header.html", "#navbar-container");
        loadFragment("/assets/components/footer.html", "#footer-container");
      })();
    </script>

    <script src="/assets/js/auth.js"></script>
    <script src="/assets/js/header-loader.js"></script>
  </body>
</html>
