<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Calmiqs Blog Post</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#4FA49A",
              accent: "#FFD580",
              tech: "#5A67D8",
            },
            fontFamily: { sans: ["Poppins", "sans-serif"] },
          },
        },
      };
    </script>

    <link rel="stylesheet" href="/assets/css/style.css?v=12" />
  </head>

  <body class="font-sans bg-[#F9FAFB] text-gray-800">
    <!-- HEADER -->
    <div id="navbar-container"></div>

    <main class="max-w-4xl mx-auto py-16 px-6">
      <!-- Post Content -->
      <div id="postContainer" class="text-center"></div>

      <!-- Post Navigation -->
      <div id="postNav" class="flex justify-between mt-12"></div>

      <!-- Share Buttons -->
      <div class="mt-12 pt-8 border-t border-gray-200">
        <h3 class="text-lg font-semibold mb-4 text-center">Share this post</h3>
        <div class="flex justify-center gap-4">
          <a
            id="shareTwitter"
            target="_blank"
            class="share-btn bg-blue-400 hover:bg-blue-500 text-white px-4 py-2 rounded-lg transition"
          >
            üê¶ Twitter
          </a>
          <a
            id="shareLinkedIn"
            target="_blank"
            class="share-btn bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition"
          >
            üíº LinkedIn
          </a>
          <a
            id="shareFacebook"
            target="_blank"
            class="share-btn bg-blue-700 hover:bg-blue-800 text-white px-4 py-2 rounded-lg transition"
          >
            üìò Facebook
          </a>
          <button
            id="copyLink"
            class="share-btn bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg transition"
          >
            üîó Copy Link
          </button>
        </div>
      </div>

      <!-- Comments Section -->
      <div id="commentsContainer" class="mt-16"></div>

      <!-- Back to Blog -->
      <div class="mt-12 text-center">
        <a
          href="blog.html"
          class="inline-block bg-primary text-white px-6 py-3 rounded-xl font-medium hover:bg-accent transition shadow"
        >
          ‚Üê Back to Blog
        </a>
      </div>
    </main>

    <footer class="bg-gray-100 py-8 mt-16 text-center text-gray-600">
      <p>¬© 2025 Calmiqs ‚Äì Wellness Meets Sustainability</p>
    </footer>

    <!-- Load Comments Script -->
    <script src="/assets/js/comments.js"></script>

    <script>
      (async () => {
        const postContainer = document.getElementById("postContainer");
        const postNav = document.getElementById("postNav");

        // Get post slug from URL
        const params = new URLSearchParams(window.location.search);
        const postSlug = params.get("post");

        if (!postSlug) {
          postContainer.innerHTML = `<p class="text-gray-500">Post not found.</p>`;
          return;
        }

        // Fallback embedded posts (same as before)
        const embeddedPosts = {
          "mindful-breathing": {
            title: "The Art of Mindful Breathing",
            date: "November 2, 2025",
            image: "https://via.placeholder.com/800x400?text=Mindful+Breathing",
            content: `
              <p>Mindful breathing allows you to focus on your breath and anchor your thoughts in the present moment. This practice reduces stress, anxiety, and improves focus.</p>
              <p class="mt-4">Start by taking deep, slow breaths, observing each inhale and exhale. Feel the air as it enters and leaves your body, grounding you in calm awareness.</p>
            `,
          },
          "eco-habits": {
            title: "5 Small Eco Habits That Reduce Stress",
            date: "November 4, 2025",
            image: "https://via.placeholder.com/800x400?text=Eco+Habits",
            content: `
              <p>Living sustainably doesn't have to be overwhelming. By making small eco-friendly changes, you can create a lifestyle that supports both the planet and your mental well-being.</p>
              <ul class="list-disc ml-6 mt-4 text-left">
                <li>Practice digital detoxes to save energy and reduce stress.</li>
                <li>Walk or cycle instead of driving short distances.</li>
                <li>Start composting to reconnect with nature.</li>
                <li>Use reusable water bottles and cups.</li>
                <li>Spend time in green spaces daily.</li>
              </ul>
            `,
          },
        };

        // Load posts from KV
        async function loadPosts() {
          try {
            const res = await fetch("/posts");
            if (!res.ok) throw new Error("KV fetch failed");
            return await res.json();
          } catch (err) {
            console.error("KV fetch failed, using fallback:", err);
            return embeddedPosts;
          }
        }

        const posts = await loadPosts();
        const keys = Object.keys(posts);
        const post = posts[postSlug];

        if (!post) {
          postContainer.innerHTML = `<p class="text-gray-500">Post not found.</p>`;
          return;
        }

        // Render post
        postContainer.innerHTML = `
          <h1 class="text-4xl font-bold text-primary mb-4">${post.title}</h1>
          <p class="text-gray-500 mb-6">${post.date}</p>
          <img src="${post.image}" alt="${
          post.imageAlt || post.title
        }" class="rounded-xl mb-8 shadow-lg mx-auto" />
          <div class="text-lg leading-relaxed text-left max-w-3xl mx-auto">${post.content}</div>
        `;

        // Setup share buttons
        const postUrl = window.location.href;
        const postTitle = encodeURIComponent(post.title);

        document.getElementById(
          "shareTwitter"
        ).href = `https://twitter.com/intent/tweet?text=${postTitle}&url=${encodeURIComponent(
          postUrl
        )}`;

        document.getElementById(
          "shareLinkedIn"
        ).href = `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(
          postUrl
        )}`;

        document.getElementById(
          "shareFacebook"
        ).href = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(postUrl)}`;

        document.getElementById("copyLink").addEventListener("click", async () => {
          try {
            await navigator.clipboard.writeText(postUrl);
            const btn = document.getElementById("copyLink");
            btn.textContent = "‚úÖ Copied!";
            setTimeout(() => (btn.textContent = "üîó Copy Link"), 2000);
          } catch (err) {
            alert("Failed to copy link");
          }
        });

        // Previous / Next navigation
        const currentIndex = keys.indexOf(postSlug);
        const prevKey = keys[currentIndex - 1];
        const nextKey = keys[currentIndex + 1];

        postNav.innerHTML = `
          <div>
            ${
              prevKey
                ? `<a href="post-template.html?post=${prevKey}" class="text-primary hover:underline">‚Üê ${posts[prevKey].title}</a>`
                : ""
            }
          </div>
          <div>
            ${
              nextKey
                ? `<a href="post-template.html?post=${nextKey}" class="text-primary hover:underline">${posts[nextKey].title} ‚Üí</a>`
                : ""
            }
          </div>
        `;

        // Initialize comments system
        window.initComments(postSlug);
      })();
    </script>

    <script>
      // Add this AFTER the post loading script
      async function loadComments() {
        const postSlug = new URLSearchParams(window.location.search).get("post");
        if (!postSlug) return;

        try {
          // Fetch approved comments for this post
          const response = await fetch(`/api/comments/${postSlug}`);
          const data = await response.json();

          if (!data.comments || data.comments.length === 0) {
            document.getElementById("commentsSection").innerHTML = `
          <div class="bg-gray-50 rounded-lg p-8 text-center">
            <p class="text-gray-600">No comments yet. Be the first to share your thoughts!</p>
          </div>
        `;
            return;
          }

          // Display comments
          const commentsHTML = data.comments
            .map(
              (comment) => `
        <div class="bg-white rounded-lg shadow p-6 mb-4 border-l-4 border-primary">
          <div class="flex items-start gap-4">
            <div class="w-12 h-12 rounded-full bg-gradient-to-br from-primary to-accent flex items-center justify-center text-white font-bold">
              ${comment.name.charAt(0).toUpperCase()}
            </div>
            <div class="flex-1">
              <h4 class="font-semibold text-gray-800">${comment.name}</h4>
              <p class="text-sm text-gray-500">${new Date(
                comment.createdAt
              ).toLocaleDateString()}</p>
              <p class="text-gray-700 mt-2">${comment.comment}</p>
            </div>
          </div>
        </div>
      `
            )
            .join("");

          document.getElementById("commentsSection").innerHTML = `
        <div class="mt-16">
          <h3 class="text-2xl font-bold text-primary mb-8">üí¨ Comments (${data.comments.length})</h3>
          ${commentsHTML}
        </div>
        <div class="mt-12">
          <h4 class="text-xl font-semibold mb-6 text-gray-800">Leave a Comment</h4>
          <form id="commentForm" class="space-y-4">
            <div class="grid md:grid-cols-2 gap-4">
              <input type="text" id="commentName" placeholder="Your name" required class="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-primary" />
              <input type="email" id="commentEmail" placeholder="your@email.com" required class="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-primary" />
            </div>
            <textarea id="commentText" placeholder="Share your thoughts..." rows="4" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-primary resize-none"></textarea>
            <button type="submit" class="bg-primary text-white px-6 py-2.5 rounded-lg font-medium hover:bg-accent transition">Submit Comment</button>
          </form>
          <div id="commentMessage" class="mt-4 text-sm"></div>
        </div>
      `;

          // Attach form handler
          document.getElementById("commentForm").addEventListener("submit", submitComment);
        } catch (error) {
          console.error("Failed to load comments:", error);
        }
      }

      async function submitComment(e) {
        e.preventDefault();
        const postSlug = new URLSearchParams(window.location.search).get("post");
        const messageEl = document.getElementById("commentMessage");

        const formData = {
          postSlug,
          name: document.getElementById("commentName").value,
          email: document.getElementById("commentEmail").value,
          comment: document.getElementById("commentText").value,
        };

        try {
          const response = await fetch("/api/comments", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(formData),
          });

          const result = await response.json();

          if (response.ok) {
            messageEl.className = "mt-4 text-sm text-green-600";
            messageEl.textContent = "‚úÖ Comment submitted! It will appear after moderation.";
            e.target.reset();
            setTimeout(() => loadComments(), 2000);
          } else {
            throw new Error(result.error || "Failed to submit");
          }
        } catch (error) {
          messageEl.className = "mt-4 text-sm text-red-600";
          messageEl.textContent = "‚ùå " + error.message;
        }
      }

      // Load comments when page loads
      document.addEventListener("DOMContentLoaded", loadComments);
    </script>
    <!-- Global scripts -->
    <script src="/assets/js/auth.js"></script>
    <script src="/assets/js/header-loader.js"></script>
  </body>
</html>
