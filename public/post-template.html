<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Calmiqs Blog Post</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#4FA49A",
              accent: "#FFD580",
              tech: "#5A67D8",
            },
            fontFamily: { sans: ["Poppins", "sans-serif"] },
          },
        },
      };
    </script>

    <link rel="stylesheet" href="/assets/css/style.css?v=12" />

    <!-- Google Analytics 4 -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-GJ0N1TQ5PP"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());
      gtag("config", "G-GJ0N1TQ5PP", {
        page_path: window.location.pathname,
        page_title: document.title,
      });
    </script>
  </head>

  <body class="font-sans bg-[#F9FAFB] text-gray-800">
    <div id="navbar-container"></div>

    <main class="max-w-4xl mx-auto py-16 px-6">
      <!-- Loading State -->
      <div id="loadingState" class="text-center py-16">
        <div
          class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-primary mb-4"
        ></div>
        <p class="text-gray-500">Loading post...</p>
      </div>

      <!-- Error State -->
      <div id="errorState" class="hidden text-center py-16">
        <div class="text-6xl mb-4">‚ö†Ô∏è</div>
        <h2 class="text-2xl font-bold text-gray-800 mb-2">Post Not Found</h2>
        <p class="text-gray-600 mb-6">
          The post you're looking for doesn't exist or has been removed.
        </p>
        <a
          href="/blog.html"
          class="inline-block bg-primary text-white px-6 py-3 rounded-lg hover:bg-accent transition"
        >
          ‚Üê Back to Blog
        </a>
      </div>

      <!-- Post Container -->
      <div id="postContainer" class="hidden">
        <!-- Post content will be inserted here -->
      </div>

      <!-- Post Navigation -->
      <div id="postNav" class="flex justify-between mt-12 gap-4"></div>

      <!-- Comments Section -->
      <div id="commentsContainer" class="mt-16"></div>
    </main>

    <div id="footer-container"></div>

    <script>
      async function loadFragment(url, selector) {
        try {
          const res = await fetch(url);
          if (!res.ok) throw new Error(`Failed to load ${url}`);
          document.querySelector(selector).innerHTML = await res.text();
        } catch (err) {
          console.error(`Failed to load ${url}:`, err);
        }
      }

      (async () => {
        const params = new URLSearchParams(window.location.search);
        const postSlug = params.get("post");

        console.log("Post slug from URL:", postSlug);

        if (!postSlug) {
          showError("No post specified");
          return;
        }

        try {
          // Fetch all posts first
          console.log("Fetching posts from /api/posts");
          const res = await fetch("/api/posts");

          if (!res.ok) {
            throw new Error(`Server responded with status ${res.status}`);
          }

          const data = await res.json();
          console.log("API Response:", data);

          // Parse posts from different response formats
          let postsArray = [];

          if (data.success && data.posts) {
            // Format: { success: true, posts: [...] }
            postsArray = data.posts;
          } else if (Array.isArray(data)) {
            // Format: [...]
            postsArray = data;
          } else if (typeof data === "object") {
            // Format: { slug1: {...}, slug2: {...} }
            postsArray = Object.entries(data).map(([slug, post]) => ({
              ...post,
              slug: slug,
            }));
          }

          console.log("Posts array:", postsArray);

          // Find the requested post
          const post = postsArray.find((p) => p.slug === postSlug);

          if (!post) {
            console.error(
              "Post not found. Available slugs:",
              postsArray.map((p) => p.slug)
            );
            showError(`Post "${postSlug}" not found`);
            return;
          }

          console.log("Post found:", post);

          // Display the post
          displayPost(post);

          // Load navigation
          loadPostNavigation(postsArray, postSlug);

          // Initialize comments
          if (window.initComments) {
            window.initComments(postSlug);
          }
        } catch (err) {
          console.error("Error loading post:", err);
          showError(err.message);
        }

        // Load header and footer
        loadFragment("/assets/components/header.html", "#navbar-container");
        loadFragment("/assets/components/footer.html", "#footer-container");
      })();

      function displayPost(post) {
        document.getElementById("loadingState").classList.add("hidden");
        document.getElementById("postContainer").classList.remove("hidden");

        // Update page title
        document.title = `${post.title} - Calmiqs`;

        // Format the date
        const postDate = new Date(post.date);
        const formattedDate = postDate.toLocaleDateString("en-US", {
          month: "long",
          day: "numeric",
          year: "numeric",
        });

        // Build tags HTML
        let tagsHTML = "";
        if (post.tags && post.tags.length > 0) {
          tagsHTML = `
            <div class="mb-8 flex flex-wrap gap-2">
              ${post.tags
                .map(
                  (tag) =>
                    `<a href="/blog.html?tags=${tag}" class="px-3 py-1 bg-primary/10 text-primary rounded-full text-sm hover:bg-primary hover:text-white transition">
                      #${tag}
                    </a>`
                )
                .join("")}
            </div>
          `;
        }

        // Build image HTML
        let imageHTML = "";
        if (post.image) {
          imageHTML = `
            <figure class="mb-8">
              <img 
                src="${post.image}" 
                alt="${post.imageAlt || post.title}" 
                class="w-full h-96 object-cover rounded-2xl shadow-lg" 
              />
              ${
                post.imageAlt
                  ? `<figcaption class="text-sm text-gray-600 mt-2 text-center italic">${post.imageAlt}</figcaption>`
                  : ""
              }
            </figure>
          `;
        }

        // Populate post content
        document.getElementById("postContainer").innerHTML = `
          <article class="bg-white rounded-2xl shadow-lg p-8 md:p-12">
            <!-- Breadcrumb -->
            <nav class="mb-6 text-sm text-gray-600" aria-label="Breadcrumb">
              <a href="/" class="text-primary hover:underline">Home</a> / 
              <a href="/blog.html" class="text-primary hover:underline">Blog</a> / 
              <span class="text-gray-800">${post.title}</span>
            </nav>

            <!-- Post Meta -->
            <div class="flex gap-4 text-sm text-gray-500 mb-4 flex-wrap">
              <span>üìÖ ${formattedDate}</span>
              <span>‚Ä¢</span>
              <span>‚úçÔ∏è ${post.author || "Calmiqs Team"}</span>
              <span>‚Ä¢</span>
              <span>‚è±Ô∏è ${post.readTime || "5 min read"}</span>
              ${
                post.category
                  ? `
                <span>‚Ä¢</span>
                <span class="px-2 py-1 bg-primary/10 text-primary rounded">${post.category}</span>
              `
                  : ""
              }
            </div>

            <!-- Title -->
            <h1 class="text-4xl md:text-5xl font-bold text-primary mb-4">
              ${post.title}
            </h1>

            <!-- Excerpt -->
            ${post.excerpt ? `<p class="text-lg text-gray-600 mb-8">${post.excerpt}</p>` : ""}

            <!-- Featured Image -->
            ${imageHTML}

            <!-- Content -->
            <div class="prose prose-lg max-w-none mb-8">
              ${post.content}
            </div>

            <!-- Tags -->
            ${tagsHTML}

            <!-- Author Bio -->
            <div class="border-t border-gray-200 pt-6 mt-8">
              <h3 class="font-semibold mb-2">About the Author</h3>
              <p class="text-gray-600">
                ${
                  post.author || "Calmiqs Team"
                } - Professional wellness and sustainability advocate.
              </p>
            </div>

            <!-- Share Buttons -->
            <div class="border-t border-gray-200 pt-6 mt-8">
              <h3 class="font-semibold mb-4">Share this article</h3>
              <div class="flex gap-3">
                <button onclick="shareOnTwitter()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">
                  üê¶ Twitter
                </button>
                <button onclick="shareOnFacebook()" class="px-4 py-2 bg-blue-700 text-white rounded-lg hover:bg-blue-800 transition">
                  üìò Facebook
                </button>
                <button onclick="copyLink()" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition">
                  üîó Copy Link
                </button>
              </div>
            </div>
          </article>
        `;
      }

      function loadPostNavigation(posts, currentSlug) {
        const currentIndex = posts.findIndex((p) => p.slug === currentSlug);
        const prevPost = currentIndex > 0 ? posts[currentIndex - 1] : null;
        const nextPost = currentIndex < posts.length - 1 ? posts[currentIndex + 1] : null;

        let navHTML = "";

        if (prevPost) {
          navHTML += `
            <a href="/post-template.html?post=${prevPost.slug}" 
               class="flex-1 p-4 bg-white rounded-lg shadow hover:shadow-lg transition">
              <div class="text-sm text-gray-600">‚Üê Previous</div>
              <div class="font-semibold text-primary">${prevPost.title}</div>
            </a>
          `;
        } else {
          navHTML += `<div class="flex-1"></div>`;
        }

        if (nextPost) {
          navHTML += `
            <a href="/post-template.html?post=${nextPost.slug}" 
               class="flex-1 p-4 bg-white rounded-lg shadow hover:shadow-lg transition text-right">
              <div class="text-sm text-gray-600">Next ‚Üí</div>
              <div class="font-semibold text-primary">${nextPost.title}</div>
            </a>
          `;
        } else {
          navHTML += `<div class="flex-1"></div>`;
        }

        document.getElementById("postNav").innerHTML = navHTML;
      }

      function showError(message) {
        document.getElementById("loadingState").classList.add("hidden");
        document.getElementById("errorState").classList.remove("hidden");

        const errorState = document.getElementById("errorState");
        errorState.querySelector("p").textContent =
          message || "The post you're looking for doesn't exist.";
      }

      // Share functions
      function shareOnTwitter() {
        const url = window.location.href;
        const title = document.title;
        window.open(
          `https://twitter.com/intent/tweet?url=${encodeURIComponent(
            url
          )}&text=${encodeURIComponent(title)}`,
          "_blank"
        );
      }

      function shareOnFacebook() {
        const url = window.location.href;
        window.open(
          `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`,
          "_blank"
        );
      }

      function copyLink() {
        navigator.clipboard.writeText(window.location.href).then(() => {
          alert("Link copied to clipboard!");
        });
      }
    </script>

    <script src="/assets/js/auth.js"></script>
    <script src="/assets/js/header-loader.js"></script>
    <script src="/assets/js/comments.js"></script>
  </body>
</html>
